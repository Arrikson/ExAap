<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aula Online</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #000;
      touch-action: manipulation;
      color: white;
    }

    #painel {
      display: none; /* ocultado */
    }

    #videos {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    video {
      width: 30vw;
      height: 30vh;
      object-fit: cover;
      margin: 5px;
      border-radius: 10px;
      border: 2px solid #fff;
      background: black;
    }

    #localVideo {
      border: 2px solid yellow;
    }

    /* Barra lateral */
    #barra-botoes {
      position: absolute;
      top: 50%;
      right: 0;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      border-radius: 10px 0 0 10px;
      z-index: 10;
    }

    .botao-icone {
      background: #007bff;
      border: none;
      color: white;
      font-size: 20px;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }

    .botao-icone:hover {
      background: #0056b3;
    }

    .encerrar {
      background: red;
    }

    #solicitacoes {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 20;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 8px;
      display: none;
    }
  </style>
</head>
<body>

<div id="solicitacoes">
  <strong>SolicitaÃ§Ãµes de entrada:</strong>
  <ul id="lista-solicitacoes"></ul>
</div>

<div id="barra-botoes">
  <!-- Copiar ID (oculto em botÃ£o com Ã­cone de entrada) -->
  <button class="botao-icone" id="copiar-id" title="Entrar">
    ðŸ”—
  </button>

  <!-- Trocar cÃ¢mera -->
  <button class="botao-icone" id="trocar-camera" title="Trocar cÃ¢mera">
    ðŸ”„
  </button>

  <!-- Ver alunos -->
  <button class="botao-icone" id="ver-alunos" title="Ver alunos">
    ðŸ‘¥
  </button>

  <!-- Encerrar aula -->
  <button class="botao-icone encerrar" id="encerrar" title="Encerrar aula">
    â›”
  </button>
</div>

<div id="videos">
  <video id="localVideo" autoplay muted playsinline></video>
</div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
  const meuIDSpan = document.createElement("span");
  let localStream, currentFacing = "user";
  const listaSolicitacoes = document.getElementById("lista-solicitacoes");
  const solicitacoesBox = document.getElementById("solicitacoes");

  const peer = new Peer();

  peer.on("open", (id) => {
    meuIDSpan.textContent = id;
    document.getElementById("copiar-id").onclick = () => {
      navigator.clipboard.writeText(id);
      alert("CÃ³digo da aula copiado.");
    };
    escutarSolicitacoes();
  });

  async function startStream(facing = "user") {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facing },
        audio: true
      });
      localStream = stream;
      document.getElementById("localVideo").srcObject = stream;
    } catch (err) {
      alert("Erro ao acessar a cÃ¢mera/microfone.");
    }
  }

  startStream();

  document.getElementById("trocar-camera").onclick = async () => {
    currentFacing = currentFacing === "user" ? "environment" : "user";
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }
    await startStream(currentFacing);
  };

  document.getElementById("encerrar").onclick = () => {
    Object.values(alunos).forEach(call => call.close());
    alert("Aula encerrada.");
    window.location.href = "/perfil_prof";
  };

  document.getElementById("ver-alunos").onclick = () => {
    document.querySelectorAll("#videos video").forEach(video => {
      video.style.display = "block";
    });
  };

  const alunos = {};

  peer.on("call", call => {
    call.answer(localStream);
    alunos[call.peer] = call;

    call.on("stream", (remoteStream) => {
      const video = document.createElement("video");
      video.srcObject = remoteStream;
      video.autoplay = true;
      video.playsInline = true;
      document.getElementById("videos").appendChild(video);
    });

    call.on("close", () => {
      const vids = document.querySelectorAll("#videos video");
      vids.forEach(v => {
        if (v.srcObject === call.remoteStream) {
          v.remove();
        }
      });
    });
  });

  function escutarSolicitacoes() {
    // Exemplo de simulaÃ§Ã£o
    setTimeout(() => {
      adicionarSolicitacao("aluno123@email.com", "Pedro");
    }, 3000);
  }

  function adicionarSolicitacao(email, nome) {
    solicitacoesBox.style.display = "block";
    const li = document.createElement("li");
    li.textContent = nome + " ";

    const btn = document.createElement("button");
    btn.textContent = "Aprovar";
    btn.onclick = async () => {
      const formData = new FormData();
      formData.append("email_prof", "{{ professor.email }}");
      formData.append("email_aluno", email);
      formData.append("nome_aluno", nome);

      const resp = await fetch("/aceitar_aluno", {
        method: "POST",
        body: formData
      });

      const result = await resp.json();
      if (resp.ok) {
        alert(`âœ… ${nome} aprovado.`);
        li.remove();
        if (!listaSolicitacoes.hasChildNodes()) {
          solicitacoesBox.style.display = "none";
        }
      } else {
        alert("Erro: " + result.erro);
      }
    };

    li.appendChild(btn);
    listaSolicitacoes.appendChild(li);
  }
</script>
</body>
</html>
