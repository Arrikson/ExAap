<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aula Online</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #000;
      color: white;
    }

    #titulo-disciplina {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 24px;
      font-weight: bold;
      z-index: 20;
    }

    #videos {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #video-professor {
      height: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #video-alunos {
      height: 50%;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      overflow-y: auto;
      padding: 10px;
      gap: 10px;
    }

    .video-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .video-container video {
      width: 160px;
      height: 120px;
      object-fit: cover;
      border: 2px solid white;
      border-radius: 10px;
      background: black;
    }

    .video-container span {
      margin-top: 5px;
      font-size: 14px;
      text-align: center;
    }

    #localVideo {
      width: 80%;
      height: 90%;
      border: 2px solid yellow;
      border-radius: 12px;
      object-fit: cover;
    }

    #barra-botoes {
      position: absolute;
      top: 50%;
      right: 0;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      border-radius: 10px 0 0 10px;
      z-index: 10;
    }

    .botao-icone {
      background: #007bff;
      border: none;
      color: white;
      font-size: 20px;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }

    .botao-icone:hover {
      background: #0056b3;
    }

    .encerrar {
      background: red;
    }

    #solicitacoes {
      position: absolute;
      top: 60px;
      left: 10px;
      z-index: 20;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 8px;
      display: none;
    }
  </style>
</head>
<body>

<div id="titulo-disciplina">Nome da Disciplina</div>

<div id="solicitacoes">
  <strong>SolicitaÃ§Ãµes de entrada:</strong>
  <ul id="lista-solicitacoes"></ul>
</div>

<div id="barra-botoes">
  <!-- NotificaÃ§Ãµes de entrada -->
  <button class="botao-icone" id="notificacao-solicitacoes" title="SolicitaÃ§Ãµes de entrada">
    ðŸ””
  </button>

  <!-- Copiar ID -->
  <button class="botao-icone" id="copiar-id" title="Entrar">
    ðŸ”—
  </button>

  <!-- Trocar cÃ¢mera -->
  <button class="botao-icone" id="trocar-camera" title="Trocar cÃ¢mera">
    ðŸ”„
  </button>

  <!-- Ver alunos -->
  <button class="botao-icone" id="ver-alunos" title="Ver alunos">
    ðŸ‘¥
  </button>

  <!-- Encerrar aula -->
  <button class="botao-icone encerrar" id="encerrar" title="Encerrar aula">
    â›”
  </button>
</div>

<div id="videos">
  <div id="video-professor">
    <video id="localVideo" autoplay muted playsinline></video>
  </div>
  <div id="video-alunos"></div>
</div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
  const meuIDSpan = document.createElement("span");
  let localStream, currentFacing = "user";
  const listaSolicitacoes = document.getElementById("lista-solicitacoes");
  const solicitacoesBox = document.getElementById("solicitacoes");

  const peer = new Peer();

  peer.on("open", (id) => {
    meuIDSpan.textContent = id;
    document.getElementById("copiar-id").onclick = () => {
      navigator.clipboard.writeText(id);
      alert("CÃ³digo da aula copiado.");
    };
    escutarSolicitacoes();
  });

  async function startStream(facing = "user") {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facing },
        audio: true
      });
      localStream = stream;
      document.getElementById("localVideo").srcObject = stream;
    } catch (err) {
      alert("Erro ao acessar a cÃ¢mera/microfone.");
    }
  }

  startStream();

  document.getElementById("trocar-camera").onclick = async () => {
    currentFacing = currentFacing === "user" ? "environment" : "user";
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }
    await startStream(currentFacing);
  };

  document.getElementById("encerrar").onclick = () => {
    Object.values(alunos).forEach(call => call.close());
    alert("Aula encerrada.");
    window.location.href = "/perfil_prof";
  };

  document.getElementById("ver-alunos").onclick = () => {
    document.querySelectorAll("#video-alunos video").forEach(video => {
      video.style.display = "block";
    });
  };

  document.getElementById("notificacao-solicitacoes").onclick = () => {
    solicitacoesBox.style.display =
      solicitacoesBox.style.display === "none" ? "block" : "none";
  };

  const alunos = {};

  peer.on("call", call => {
    call.answer(localStream);
    alunos[call.peer] = call;

    call.on("stream", (remoteStream) => {
      const container = document.createElement("div");
      container.className = "video-container";

      const video = document.createElement("video");
      video.srcObject = remoteStream;
      video.autoplay = true;
      video.playsInline = true;

      const nome = document.createElement("span");
      nome.textContent = "Aluno"; // opcionalmente, personalizar com nome real

      container.appendChild(video);
      container.appendChild(nome);
      document.getElementById("video-alunos").appendChild(container);
    });

    call.on("close", () => {
      const containers = document.querySelectorAll("#video-alunos .video-container");
      containers.forEach(c => {
        if (c.querySelector("video").srcObject === call.remoteStream) {
          c.remove();
        }
      });
    });
  });

  function escutarSolicitacoes() {
    // Exemplo de simulaÃ§Ã£o
    setTimeout(() => {
      adicionarSolicitacao("aluno123@email.com", "Pedro");
    }, 3000);
  }

  function adicionarSolicitacao(email, nome) {
    solicitacoesBox.style.display = "block";
    const li = document.createElement("li");
    li.textContent = nome + " ";

    const btn = document.createElement("button");
    btn.textContent = "Aprovar";
    btn.onclick = async () => {
      const formData = new FormData();
      formData.append("email_prof", "{{ professor.email }}");
      formData.append("email_aluno", email);
      formData.append("nome_aluno", nome);

      const resp = await fetch("/aceitar_aluno", {
        method: "POST",
        body: formData
      });

      const result = await resp.json();
      if (resp.ok) {
        alert(`âœ… ${nome} aprovado.`);
        li.remove();
        if (!listaSolicitacoes.hasChildNodes()) {
          solicitacoesBox.style.display = "none";
        }
      } else {
        alert("Erro: " + result.erro);
      }
    };

    li.appendChild(btn);
    listaSolicitacoes.appendChild(li);
  }
</script>
</body>
</html>
