<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aula Online com PeerJS</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #000;
      touch-action: manipulation;
      color: white;
    }

    #painel {
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      z-index: 5;
      width: 100vw;
      box-sizing: border-box;
    }

    #painel h1 {
      margin: 0 0 10px 0;
      font-weight: normal;
      font-size: 1.8rem;
    }

    #painel p {
      margin: 4px 0;
      font-size: 1rem;
    }

    #disciplina-container, #codigo-aula {
      margin-top: 10px;
    }

    #codigo-aula {
      font-size: 1rem;
    }

    #codigo-aula button {
      margin-left: 10px;
      padding: 4px 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    #status, #controles, #solicitacoes {
      margin-top: 10px;
      font-size: 1rem;
    }

    #controles button {
      padding: 8px;
      margin-right: 10px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
      background-color: #007bff;
      color: white;
      transition: background-color 0.3s;
    }

    #controles button:hover {
      background-color: #0056b3;
    }

    #videos {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      padding-top: 150px; /* Espaço para o painel */
      box-sizing: border-box;
    }

    video {
      width: 30vw;
      height: 30vh;
      object-fit: cover;
      margin: 5px;
      border-radius: 10px;
      border: 2px solid #fff;
      background: black;
    }

    #localVideo {
      border: 2px solid yellow;
    }

    #ver-colegas {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 4;
      background: #fff;
      color: #000;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      border: none;
    }
  </style>
</head>
<body>

  <div id="painel">
    <h1>Bem-vindo à sua Sala Virtual</h1>
    <p><strong>Professor:</strong> {{ professor.nome }}</p>
    <p><strong>Email:</strong> {{ professor.email }}</p>

    <div id="disciplina-container"><strong>Disciplina:</strong> <span id="disciplina">Carregando...</span></div>
    <div id="codigo-aula">
      <strong>Código da Aula:</strong> <span id="meu-id">Gerando...</span> 
      <button id="copiar-id">Copiar</button>
    </div>

    <div id="status">Aguardando conexão...</div>

    <div id="solicitacoes">
      <strong>Solicitações de entrada:</strong>
      <ul id="lista-solicitacoes"></ul>
    </div>

    <div id="controles">
      <button id="trocar-camera">Trocar câmera</button>
      <button id="encerrar">Encerrar aula</button>
    </div>
  </div>

  <div id="videos">
    <video id="localVideo" autoplay muted playsinline></video>
  </div>

  <button id="ver-colegas">Ver colegas</button>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

  <script>
    const disciplinaSpan = document.getElementById("disciplina");
    const meuIDSpan = document.getElementById("meu-id");
    const copiarIDBtn = document.getElementById("copiar-id");
    const videoContainer = document.getElementById("videos");
    const localVideo = document.getElementById("localVideo");
    const listaSolicitacoes = document.getElementById("lista-solicitacoes");

    let localStream;
    let alunos = {};

    // Email do professor do backend
    const emailProfessor = "{{ professor.email }}";

    // Disciplina - se quiser, pode usar {{ nome_disciplina }} do backend e renderizar direto,
    // aqui deixo um fallback dinâmico para demonstrar.
    const nomeDisciplina = "{{ nome_disciplina }}" || "Matemática";

    disciplinaSpan.textContent = nomeDisciplina;

    const peer = new Peer();

    peer.on("open", (id) => {
      meuIDSpan.textContent = id;
      copiarIDBtn.onclick = () => {
        navigator.clipboard.writeText(id);
        copiarIDBtn.innerText = "Copiado!";
        setTimeout(() => copiarIDBtn.innerText = "Copiar", 1500);
      };
      escutarSolicitacoes();
    });

    async function startStream() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localStream = stream;
        localVideo.srcObject = stream;
      } catch (err) {
        alert("Erro ao acessar câmera/microfone.");
      }
    }

    startStream();

    document.getElementById("trocar-camera").onclick = async () => {
      alert("Alternar câmera não implementado.");
    };

    document.getElementById("encerrar").onclick = () => {
      Object.values(alunos).forEach(call => call.close());
      alert("Aula encerrada.");
      window.location.href = "/perfil_prof";
    };

    peer.on("call", call => {
      call.answer(localStream);
      alunos[call.peer] = call;

      call.on("stream", (remoteStream) => {
        const video = document.createElement("video");
        video.srcObject = remoteStream;
        video.autoplay = true;
        video.playsInline = true;
        videoContainer.appendChild(video);
      });

      call.on("close", () => {
        // Remover vídeo do aluno quando desconectar
        const vids = videoContainer.querySelectorAll("video");
        vids.forEach(v => {
          if (v.srcObject === call.remoteStream) {
            videoContainer.removeChild(v);
          }
        });
      });
    });

    function escutarSolicitacoes() {
      // Simulação de solicitação, substituir com WebSocket ou outra tecnologia real
      setTimeout(() => {
        adicionarSolicitacao("aluno123@email.com", "Pedro");
      }, 2000);
    }

    function adicionarSolicitacao(alunoEmail, nome) {
      const li = document.createElement("li");
      li.textContent = nome + " ";

      const btn = document.createElement("button");
      btn.textContent = "Aprovar";
      btn.onclick = async () => {
        const formData = new FormData();
        formData.append("email_prof", emailProfessor);
        formData.append("email_aluno", alunoEmail);
        formData.append("nome_aluno", nome);

        const resposta = await fetch("/aceitar_aluno", {
          method: "POST",
          body: formData
        });

        const resultado = await resposta.json();
        if (resposta.ok) {
          alert(`✅ ${nome} aprovado.`);
          li.remove();
        } else {
          alert("Erro: " + resultado.erro);
        }
      };

      li.appendChild(btn);
      listaSolicitacoes.appendChild(li);
    }

    document.getElementById("ver-colegas").onclick = () => {
      document.querySelectorAll("#videos video").forEach(video => {
        video.style.display = "block";
      });
    };
  </script>

</body>
</html>
