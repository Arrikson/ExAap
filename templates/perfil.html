<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perfil do Aluno - Estilo BAI</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: #f5f7fa; /* fundo mais suave */
    color: #2c3e50;
    max-width: 480px;
    margin: auto;
  }

  .top-bar {
    background: linear-gradient(135deg, #00c9ff, #92fe9d); /* Mantida */
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    border-radius: 0 0 20px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .top-bar img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
  }

  .top-bar .info {
    display: flex;
    flex-direction: column;
  }

  .top-bar .info h2 {
    font-size: 1rem;
    margin: 0;
    color: #ffffff;
  }

  .top-bar .info p {
    margin: 2px 0;
    color: rgba(255, 255, 255, 0.9);
  }

  .saldo {
    font-size: 1.1rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #34495e;
    flex-direction: column;
    align-items: flex-start;
    margin-top: 8px;
  }

  .saldo button {
    background: none;
    border: none;
    color: #2c3e50;
    cursor: pointer;
  }

  .carrossel-indicadores {
    margin-top: 8px;
    text-align: center;
  }

  .carrossel-indicadores span {
    display: inline-block;
    width: 10px;
    height: 10px;
    margin: 0 3px;
    border-radius: 50%;
    background-color: #1abc9c;
  }

  .acoes {
    display: flex;
    justify-content: space-around;
    background: #ecf0f1;
    padding: 15px 0;
    flex-wrap: wrap;
  }

  .acao {
    width: 70px;
    height: 70px;
    background: #d0f0ef;
    border-radius: 15px;
    text-align: center;
    padding-top: 8px;
    margin: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  .acao i {
    font-size: 20px;
    display: block;
    color: #16a085;
  }

 .acao span {
   font-size: 12px;
   color: #000000; /* preto */
 }
  
  .ultimas-aulas {
    background: #ffffff;
    border-radius: 15px;
    margin: 15px;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .aula-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dfe6e9;
    padding: 8px 0;
  }

  .aula-info {
    flex: 1;
    color: #2c3e50;
  }

  .aula-valor {
    font-weight: bold;
    color: #2c3e50;
  }

  p {
  color: inherit;
  text-decoration: none;
}

p a {
  color: inherit;
  text-decoration: none;
  pointer-events: none;
}
  
  .footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    max-width: 480px;
    background: #ffffff;
    border-top: 1px solid #dcdde1;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 10px 0;
  }

  .footer .item {
    text-align: center;
    color: #7f8c8d;
    font-size: 12px;
  }

  .footer .item.active {
    color: #1abc9c;
  }

  .footer .item i {
    font-size: 20px;
    display: block;
  }
</style>
</head>
<body>
  <div class="top-bar">
    <img src="/static/perfil.png" alt="Perfil" />
    <div class="info">
      <h2>Olá, {{ aluno.nome }} 👋</h2>
      <p>B.I: {{ aluno.bilhete }}</p>

      <div class="saldo">
        <p style="margin: 0; font-size: 13px; font-family: 'Arial', sans-serif;">
          <strong style="font-size: 10px;">Por pagar:</strong>
          <span id="valor-divida" data-real="{{ total_gasto }}">Kz {{ total_gasto }},00</span>
          <button onclick="toggleVisibilidade()" style="margin-left: 10px;">👁️</button><br>
        </p>

        <strong style="font-size: 13px;">Nível de Inglês:</strong>
        <span id="nivel-ingles">{{ aluno.nivel_ingles }}</span>
      </div>

      <div class="carrossel-indicadores">
        <span></span>
        <span style="opacity: 0.3;"></span>
      </div>
    </div>
  </div>

  <div class="acoes">
    <div class="acao" onclick="toggleAulas()">
      <i>📘</i>
      <span>Ver Aulas</span>
    </div>
    <div class="acao" onclick="verNotificacao()">
      <i>🔔👨‍🏫</i>
      <span>Sala de aula</span>
    </div>
    <div class="acao" onclick="verHorario()">
      <i>📅</i>
      <span>Ver Horário</span>
    </div>
    <div class="acao" onclick="toggle('sec-notas')">
      <i>📝</i>
      <span>Ver Notas</span>
    </div>
    <div class="acao" onclick="toggleProfessor()">
      <i>👨‍🏫</i>
      <span>Ver Professor</span>
    </div>
  </div>

<!-- Desafio de Inglês -->
<div class="jogo-ingles" id="jogo-ingles" style="margin: 15px; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); max-height: 300px; overflow-y: auto; position: relative;">
  <h3 style="margin-top: 0;">🧠 Desafio de Inglês</h3>
  <p><strong>Nível:</strong> <span id="nivel-aluno">{{ aluno.nivel_ingles }}</span></p>
  <p id="pergunta-texto" style="margin: 10px 0;">Loading...</p>

  <input type="text" id="resposta-input" placeholder="Escreve a resposta..." style="width: 100%; padding: 8px; font-size: 14px; margin-bottom: 60px;" />

  <button onclick="verificarResposta()" style="
    position: absolute;
    bottom: 20px;
    left: 20px;
    right: 20px;
    padding: 12px;
    background: #1abc9c;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;">
    Verificar
  </button>

  <p id="mensagem-feedback" style="margin-top: 10px;"></p>
</div>


  </div>

  <div class="footer">
    <div class="item active">
      <i>👤</i>
      O Meu Perfil
    </div>
    <div class="item">
      <i>💳</i>
      Pagamentos
    </div>
    <div class="item">
      <i>📂</i>
      Menu
    </div>
  </div>

  <!-- Seção para exibir detalhes das aulas -->
  <div id="sec-aula" style="display:none;">
    <p id="aulas-dadas"></p>
    <p id="aulas-restantes"></p>
    <ul id="lista-aulas"></ul>
  </div>

  <!-- Seção do professor -->
  <div id="professor-nome" style="display:none;"></div>

  <!-- Seção de notificações -->
  <div id="notificacao-mensagem" style="display:none;"></div>
  <span id="contador-aulas"></span>

  <!-- Seção de horário -->
  <div id="sec-horario" style="display:none;">
    <ul id="lista-horario"></ul>
  </div>

  <!-- Seção para chamadas ao vivo -->
  <div id="info-aula" style="display:none;">
    <span id="sala-id"></span>
    <button onclick="entrarNaAulaDireto()">Entrar na Aula</button>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, doc, onSnapshot, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyChMkODt7BhNLD-fK5NrY6-LmjJL6DtBIE",
    authDomain: "exap-8a935.firebaseapp.com",
    projectId: "exap-8a935",
    storageBucket: "exap-8a935.appspot.com",
    messagingSenderId: "664710895978",
    appId: "1:664710895978:web:304790f37d7561d9b1ed13"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const nomeAluno = "{{ aluno.nome }}";
  const chamadaRef = doc(db, "chamadas_ao_vivo", nomeAluno);
  const infoAulaDiv = document.getElementById("info-aula");
  const salaIdSpan = document.getElementById("sala-id");

  onSnapshot(chamadaRef, (docSnap) => {
    if (docSnap.exists()) {
      const dados = docSnap.data();
      if (dados.status === "pendente") {
        salaIdSpan.textContent = dados.sala;
        infoAulaDiv.style.display = "block";
        const aceitar = confirm(`📡 O professor ${dados.professor} está te chamando para uma aula. Deseja entrar?`);
        updateDoc(chamadaRef, {
          status: aceitar ? "aceito" : "rejeitado"
        });
        if (aceitar) {
          window.location.href = `/sala_virtual_aluno/${dados.sala}`;
        }
      }
    }
  });

  window.toggleAulas = async function () {
    const div = document.getElementById("sec-aula");
    const aulasDadas = document.getElementById("aulas-dadas");
    const aulasRestantes = document.getElementById("aulas-restantes");
    const listaAulas = document.getElementById("lista-aulas"); 
    
    if (div.style.display === "block") {
      div.style.display = "none";
      return;
    }

    try {
      const response = await fetch("/ver-aulas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ aluno: nomeAluno })
      });

      const data = await response.json();

      if (data.erro) {
        aulasDadas.textContent = "Erro ao carregar as aulas.";
        aulasRestantes.textContent = "";
        listaAulas.innerHTML = "";
        return;
      }

      aulasDadas.textContent = `✅ Já teve: ${data.aulas_dadas} aulas`;
      aulasRestantes.textContent = `📌 Faltam: ${data.restantes} aulas`;
      listaAulas.innerHTML = "";
      data.aulas.forEach((aula, i) => {
        const li = document.createElement("li");
        li.textContent = `${i + 1}. 📅 ${aula.data} 🕐 ${aula.horario}`;
        listaAulas.appendChild(li);
      });
    } catch (err) {
      aulasDadas.textContent = "❌ Erro ao buscar dados.";
      aulasRestantes.textContent = "";
      listaAulas.innerHTML = "";
    }

    div.style.display = "block";
  };

  window.toggleProfessor = function () {
    const container = document.getElementById("professor-nome");
    if (container.style.display === "block") {
      container.style.display = "none";
      return;
    }
    fetch(`/meu-professor-status/${nomeAluno}`)
      .then(response => response.json())
      .then(data => {
        const statusIcon = data.online ? '🟢' : '⚪';
        const statusText = data.online ? 'Online' : 'Offline';
        container.innerHTML = `${statusIcon} Professor: ${data.professor} <span class="status-icon">(${statusText})</span>`;
        container.style.display = "block";
      })
      .catch(() => {
        container.innerHTML = "Professor não encontrado.";
        container.style.display = "block";
      });
  };

  window.verNotificacao = function () {
    fetch("/verificar-notificacao", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ aluno: nomeAluno })
    })
    .then(response => response.json())
    .then(data => {
      const notificacaoEl = document.getElementById("notificacao-mensagem");
      const contadorAulas = document.getElementById("contador-aulas");
      if (data.notificacao === true) {
        window.professorEmailAtual = data.professor_email;
        notificacaoEl.innerHTML = `
          A tua aula irá começar
          <button class="notificar-btn" onclick="desativarNotificacaoERedirecionar()">Vista</button>
        `;
        notificacaoEl.style.display = "block";
        contadorAulas.innerText = "(1)";
      } else {
        notificacaoEl.style.display = "none";
        contadorAulas.innerText = "";
      }
    });
  };

  window.desativarNotificacaoERedirecionar = function () {
    fetch("/desativar-notificacao", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ aluno: nomeAluno })
    })
    .then(() => {
      document.getElementById("notificacao-mensagem").style.display = "none";
      document.getElementById("contador-aulas").innerText = "";
      if (window.professorEmailAtual) {
        const sala = encodeURIComponent(`${window.professorEmailAtual}-${nomeAluno}`);
        window.location.href = `/sala_virtual_aluno/${sala}`;
      }
    });
  };

  window.verHorario = async function () {
    const container = document.getElementById("sec-horario");
    const listaHorario = document.getElementById("lista-horario");

    if (container.style.display === "block") {
      container.style.display = "none";
      return;
    }

    try {
      const res = await fetch(`/ver-horario-aluno/${encodeURIComponent(nomeAluno)}`);
      const data = await res.json();
      listaHorario.innerHTML = "";

      if (data.erro) {
        const li = document.createElement("li");
        li.textContent = "⚠️ Horário não encontrado.";
        listaHorario.appendChild(li);
      } else {
        for (const [dia, horarios] of Object.entries(data.horario)) {
          const diaItem = document.createElement("li");
          diaItem.innerHTML = `<strong>📅 ${traduzirDia(dia)}:</strong>`;
          listaHorario.appendChild(diaItem);

          horarios.forEach(h => {
            const horaItem = document.createElement("li");
            horaItem.textContent = `- ${h}`;
            horaItem.style.marginLeft = "15px";
            listaHorario.appendChild(horaItem);
          });
        }
      }
    } catch (e) {
      listaHorario.innerHTML = "<li>❌ Erro ao buscar horário.</li>";
    }

    container.style.display = "block";
  };

  function traduzirDia(diaAbreviado) {
    const dias = {
      "Seg": "Segunda-feira",
      "Ter": "Terça-feira",
      "Qua": "Quarta-feira",
      "Qui": "Quinta-feira",
      "Sex": "Sexta-feira",
      "Sab": "Sábado",
      "Dom": "Domingo"
    };
    return dias[diaAbreviado] || diaAbreviado;
  }

  function toggle(id) {
    const el = document.getElementById(id);
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
  }

  function fazerLogout() {
    const nomeAluno = document.getElementById("aluno-id").value;
    fetch("/logout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nome: nomeAluno })
    })
    .then(() => window.location.href = "/")
    .catch(error => console.error("Erro ao fazer logout:", error));
  }

  function entrarNaAulaDireto() {
    const salaId = document.getElementById("sala-id").textContent;
    if (salaId) {
      window.location.href = `/sala_virtual_aluno/${salaId}`;
    }
  }

 let perguntas = [];
let perguntaAtual = 0;
let nivelAtual = "{{ aluno.nivel_ingles }}".toLowerCase();

// 🔹 Mapeamento dos níveis
const mapaNiveis = {
  basico: "iniciante",
  inicial: "iniciante",
  intermedio: "intermediario",
  medio: "intermediario",
  avancado: "avancado",
  fluente: "fluente"
};

async function carregarPerguntas() {
  try {
    const nivelBusca = mapaNiveis[nivelAtual] || nivelAtual;

    const resposta = await fetch(`https://beckend-exaap.onrender.com/pergunta-ingles?nome=${encodeURIComponent(nomeAluno)}&nivel=${encodeURIComponent(nivelBusca)}`);
    const dados = await resposta.json();

    // 🔹 Se o backend informou que subiu de nível
    if (dados.mensagem && dados.novo_nivel) {
      nivelAtual = dados.novo_nivel;
      document.getElementById("nivel-aluno").textContent = dados.novo_nivel.toUpperCase();

      const mensagemEl = document.getElementById("mensagem-feedback");
      mensagemEl.textContent = `🚀 ${dados.mensagem}`;
      setTimeout(() => mensagemEl.textContent = "", 2000);
    }

    // 🔹 Se tem pergunta para exibir
    if (dados.pergunta) {
      perguntas = [dados.pergunta];
      mostrarPergunta(dados.pergunta, dados.nivel);
    }
    else if (dados.status === "maximo") {
      document.getElementById("pergunta-texto").textContent = "🏆 Você já está no nível máximo!";
    }
    else if (dados.status === "final-nivel") {
      document.getElementById("pergunta-texto").textContent = "🎉 Terminaste todas as perguntas!";
    }
    else {
      document.getElementById("pergunta-texto").textContent = "Nenhuma pergunta disponível.";
    }

  } catch (erro) {
    console.error("Erro ao carregar pergunta:", erro);
    document.getElementById("pergunta-texto").textContent = "Erro ao carregar a pergunta.";
  }
}

async function mostrarPergunta() {
  try {
    const nivelBusca = mapaNiveis[nivelAtual] || nivelAtual;

    const response = await fetch(`https://beckend-exaap.onrender.com/pergunta-ingles?nome=${encodeURIComponent(nomeAluno)}&nivel=${encodeURIComponent(nivelBusca)}`);
    const data = await response.json();

    const perguntaTexto = document.getElementById("pergunta-texto");
    const respostaInput = document.getElementById("resposta-input");
    const mensagemFeedback = document.getElementById("mensagem-feedback");

    if (data.pergunta) {
      perguntaTexto.textContent = data.pergunta;
      document.getElementById("nivel-aluno").textContent = data.nivel;
      nivelAtual = data.nivel;

      if (data.id) {
        respostaInput.dataset.perguntaId = data.id;
      } else {
        console.warn("⚠️ Nenhum ID recebido da pergunta!");
        delete respostaInput.dataset.perguntaId;
      }

      respostaInput.value = "";
      mensagemFeedback.textContent = "";

    } else if (data.status === "final-nivel") {
      perguntaTexto.textContent = "🎉 Terminaste todas as perguntas!";
      delete respostaInput.dataset.perguntaId;
    } else {
      perguntaTexto.textContent = "Nenhuma pergunta disponível.";
      delete respostaInput.dataset.perguntaId;
    }

  } catch (err) {
    console.error("Erro ao buscar pergunta:", err);
    document.getElementById("pergunta-texto").textContent = "Erro ao carregar a pergunta.";
    delete document.getElementById("resposta-input").dataset.perguntaId;
  }
}

async function verificarResposta() {
  const respostaInput = document.getElementById('resposta-input');
  const resposta = respostaInput.value.trim();
  const perguntaId = respostaInput.dataset.perguntaId;
  const mensagemEl = document.getElementById('mensagem-feedback');

  if (!resposta) {
    mensagemEl.textContent = "⚠️ Escreve uma resposta antes de verificar.";
    return;
  }

  if (!perguntaId) {
    mensagemEl.textContent = "⚠️ Nenhuma pergunta carregada.";
    return;
  }

  try {
    const response = await fetch("https://beckend-exaap.onrender.com/verificar-resposta", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        nome: nomeAluno,
        resposta: resposta,
        pergunta_id: perguntaId
      }),
    });

    const data = await response.json();

    if (data.acertou) {
      if (data.subiu_nivel) {
        mensagemEl.textContent = `🎉 Parabéns! Subiste para o nível ${data.novo_nivel.toUpperCase()}!`;
      } else {
        mensagemEl.textContent = "✔️ Resposta correta!";
      }

      respostaInput.value = "";

      setTimeout(() => {
        mensagemEl.textContent = "";
        proximaPergunta(); // 🔹 Agora avança direto para a próxima pergunta
      }, 1500);

    } else {
      mensagemEl.textContent = "❌ Resposta incorreta. Tenta novamente!";
    }

  } catch (error) {
    console.error("Erro ao verificar resposta:", error);
    mensagemEl.textContent = "Erro na verificação. Tenta mais tarde.";
  }
}

async function proximaPergunta() {
  const resposta = await fetch(`https://beckend-exaap.onrender.com/proxima-pergunta`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nome: nomeAluno })
  });

  const dados = await resposta.json();

  if (dados.pergunta) {
    document.getElementById("pergunta-texto").textContent = dados.pergunta;
    document.getElementById("nivel-aluno").textContent = dados.nivel.toUpperCase();
    document.getElementById("resposta-input").dataset.perguntaId = dados.id || "";
  } 
  else if (dados.status === "final-nivel") {
    // Mensagem final antes de subir de nível
    document.getElementById("pergunta-texto").textContent = "🎉 Terminaste todas as perguntas deste nível!";
    
    // Chama subirNivel após um pequeno delay
    setTimeout(() => {
      subirNivel(); 
    }, 1500);
  } 
  else {
    document.getElementById("pergunta-texto").textContent = "Nenhuma pergunta disponível.";
  }
}

    
async function subirNivel() {
  try {
    const resposta = await fetch('https://beckend-exaap.onrender.com/subir-nivel', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nome: nomeAluno }) // 🔹 Agora envia o nome
    });

    const dados = await resposta.json();

    if (dados.novo_nivel) {
      nivelAtual = dados.novo_nivel;
      document.getElementById('nivel-aluno').textContent = dados.novo_nivel.toUpperCase();
      perguntaAtual = 0;

      // 🔹 Mensagem temporária de parabéns
      const mensagemEl = document.getElementById('mensagem-feedback');
      mensagemEl.textContent = `🚀 Parabéns! Agora você está no nível ${dados.novo_nivel.toUpperCase()}!`;

      // 🔹 Espera um pouco antes de carregar a primeira pergunta do novo nível
      setTimeout(async () => {
        mensagemEl.textContent = "";

        const proxPergunta = await fetch(`https://beckend-exaap.onrender.com/proxima-pergunta`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nome: nomeAluno })
        });

        const dadosPergunta = await proxPergunta.json();

        if (dadosPergunta.pergunta) {
          document.getElementById("pergunta-texto").textContent = dadosPergunta.pergunta;
          document.getElementById("nivel-aluno").textContent = dadosPergunta.nivel.toUpperCase();
          document.getElementById("resposta-input").dataset.perguntaId = dadosPergunta.id || "";
        } else if (dadosPergunta.status === "final-nivel") {
          document.getElementById("pergunta-texto").textContent = "🎉 Terminaste todas as perguntas!";
        } else {
          document.getElementById("pergunta-texto").textContent = "Nenhuma pergunta disponível.";
        }
      }, 1500);

    } else if (dados.erro) {
      console.error("Erro ao subir de nível:", dados.erro);
    }

  } catch (error) {
    console.error("Erro ao subir de nível:", error);
  }
}

carregarPerguntas();


window.toggleVisibilidade = function () {
  const dividaEl = document.getElementById("valor-divida");
  const inglesEl = document.getElementById("nivel-ingles");

  const visivel = dividaEl.textContent.includes("Kz");

  if (visivel) {
    dividaEl.textContent = "•••••••";
    inglesEl.textContent = "•••••••";
  } else {
    const valorReal = dividaEl.dataset.real;
    dividaEl.textContent = `Kz ${valorReal},00`;
    inglesEl.textContent = "{{ aluno.nivel_ingles }}";
  }
};
</script>
</body>
</html>
