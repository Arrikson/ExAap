<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sala Virtual 100ms - Professor</title>
  <style>
    body {
      margin: 0;
      background: #000;
      font-family: "Roboto", sans-serif;
      color: #fff;
    }
    #container {
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      font-size: 16px;
      border-radius: 5px;
      border: none;
    }
    button {
      cursor: pointer;
    }
    #result a {
      color: #0af;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="container">
    <h2>Professor - Criar sala 100ms</h2>

    <!-- Nome de sala -->
    <input id="nomeSala" placeholder="Nome da sala (ex: Ingles-Alfredo)" />
    <button id="criarBtn">Criar Sala</button>
    <div id="result"></div>

    <!-- Enviar ao aluno -->
    <label>Nome do aluno:</label>
    <input id="alunoNome" placeholder="Nome do aluno" />
    <button id="enviarLinkBtn" disabled>Enviar link ao aluno</button>
  </div>

<script>
const criarBtn = document.getElementById('criarBtn');
const result = document.getElementById('result');
const enviarLinkBtn = document.getElementById('enviarLinkBtn');
const alunoNome = document.getElementById('alunoNome');

let lastRoomCodeHost = null;   
let lastRoomCodeGuest = null;
let linkProfessor = null;    

// ===============================
// 1️⃣ Criar Sala via /create-room (POST)
// ===============================
criarBtn.onclick = async () => {
  const name = document.getElementById('nomeSala').value || 'aula-' + Date.now();

  try {
    const resp = await fetch('/create-room', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name })
    });

    if (!resp.ok) {
      const text = await resp.text();
      throw new Error(text);
    }

    const json = await resp.json();

    // ✅ Pegamos os dois códigos e o link do professor
    lastRoomCodeHost = json.room_code_host;
    lastRoomCodeGuest = json.room_code_guest;
    linkProfessor = json.prebuilt_links?.host;

    if (!lastRoomCodeHost || !lastRoomCodeGuest || !linkProfessor) {
      result.innerHTML = `<p style="color:red;">⚠️ Sala criada, mas algum dos códigos (host/guest) não foi retornado.</p>
                          <p>Verifique se o Template 100ms possui ambos os roles habilitados.</p>`;
      return;
    }

    result.innerHTML = `
      <p><strong>Room ID:</strong> ${json.room_id || 'N/D'}</p>
      <p><strong>Room Code (HOST):</strong> ${lastRoomCodeHost}</p>
      <p><strong>Room Code (GUEST):</strong> ${lastRoomCodeGuest}</p>
      <p><strong>Entrar na sala:</strong>
        <a href="${linkProfessor}" target="_blank">${linkProfessor}</a>
      </p>
      <p>Abra este link para entrar como <strong>Professor (HOST)</strong>.</p>
    `;

    enviarLinkBtn.disabled = false;

  } catch (err) {
    console.error(err);
    alert('Erro ao criar sala: ' + err.message);
  }
};

// ==============================================
// 2️⃣ Enviar Room Code do Aluno via /enviar-id-aula
// ==============================================
enviarLinkBtn.onclick = async () => {
  const aluno = alunoNome.value.trim();
  if (!aluno || !lastRoomCodeGuest) {
    alert('Informe o nome do aluno e crie a sala primeiro.');
    return;
  }

  try {
    const resp = await fetch('/enviar-id-aula', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        aluno: aluno,
        professor: "{{ email }}",
        room_code: lastRoomCodeGuest  // ✅ Agora enviamos o código GUEST
      })
    });

    if (resp.ok) {
      alert('✅ Código (GUEST) enviado ao aluno com sucesso!');
    } else {
      alert('❌ Falha ao registrar o código no backend.');
    }

  } catch (err) {
    console.error(err);
    alert('Erro ao enviar ID ao aluno: ' + err.message);
  }
};
</script>
</body>
</html>
