<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil do Professor</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap √çcones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

 <style>
  body {
    margin: 0;
    font-family: 'Nunito', sans-serif;
    background: #f4f4f8;
    color: #333;
    padding-bottom: 70px;
  }

  .header-bai {
    display: flex;
    align-items: center;
    gap: 15px;
    background: linear-gradient(135deg, #00c9ff, #92fe9d);
    padding: 20px;
    border-radius: 0 0 20px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .header-bai img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
  }

  .header-bai .info {
    flex: 1;
  }

  .header-bai .info h2 {
    margin: 0;
    font-size: 20px;
  }

  .header-bai .info p {
    margin: 2px 0;
    font-size: 14px;
  }

  .header-bai .saldo {
    font-size: 16px;
    font-weight: bold;
  }

  .saldo-toggle {
    background-color: #fff;
    color: #000;
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 8px;
    cursor: pointer;
    margin-left: 10px;
  }

  .btn-ver-aulas {
    margin-top: 10px;
    background-color: #ffc107;
    color: #000;
    border: none;
    padding: 10px;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
  }

  /* NOVO: Bot√µes estilo BAI */
  /* NOVO: Bot√µes estilo BAI */
.botao-menu {
  display: flex;
  justify-content: space-between;
  flex-wrap: nowrap; /* N√£o quebrar os bot√µes */
  gap: 10px;
  margin: 20px 15px;
}

.botao-menu button {
  flex: 1;
  background: linear-gradient(135deg, #00c9ff, #92fe9d);
  border: none;
  border-radius: 16px;
  padding: 15px 10px;
  font-size: 14px;
  font-weight: 600;
  color: #000;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: 0.2s ease;
  text-align: center;
}

.botao-menu button:hover {
  opacity: 0.85;
}

   .ultimas-aulas {
    padding: 20px;
  }

  .ultimas-aulas h3 {
    margin-bottom: 15px;
  }

  .aula-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    cursor: pointer;
  }

  .aula-item i {
    color: #007bff;
    margin-right: 10px;
  }

  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    z-index: 100;
  }

  .bottom-nav button {
    background: none;
    border: none;
    font-size: 20px;
    color: #444;
    cursor: pointer;
  }

  /* Se√ß√µes din√¢micas */
  .secao-dinamica {
    display: none;
    padding: 20px;
    margin: 10px 15px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.05);
  }

  .secao-dinamica h4 {
    margin-bottom: 10px;
    color: #00796b;
  }

  /* Responsividade: impedir quebra dos bot√µes mesmo em telas pequenas */
  @media (max-width: 700px) {
    .botao-menu {
      flex-wrap: nowrap;
      overflow-x: auto; /* rolagem horizontal se necess√°rio */
    }

    .botao-menu button {
      min-width: 120px;
      flex: 0 0 auto;
    }
  }
</style>
</head>
<body>
  <!-- Novo cabe√ßalho estilo BAI -->
  <div class="header-bai">
    <img src="/static/foto_perfil.png" alt="Foto Perfil">
    <div class="info">
      <h2>Ol√°, {{ professor.nome_completo }} üëã</h2>
      <p>N¬∫ B.I: {{ professor.bilhete }}</p>
      <p class="saldo">Saldo: <span id="saldo">Kz 00,00</span>
        <span class="saldo-toggle" onclick="toggleSaldo()">üëÅÔ∏è</span></p>
  </div>

  <!-- Bot√µes principais -->
 <div class="botao-menu">
   <button onclick="toggleSection('meus-alunos', listarMeusAlunos)">Meus Alunos</button>
  <button onclick="toggleSection('alunos-disponiveis', buscarAlunosDisponiveis)">Alunos Dispon√≠veis</button>
  <button onclick="toggleSection('aulas-dia', mostrarAulasDoDia)">Aulas do Dia</button>
  <button onclick="toggleSection('aulas-semana', mostrarAulasDaSemana)">Aulas da Semana</button>
</div>

  <!-- √öltimas aulas -->
  <div class="ultimas-aulas">
    <h3>Hoje, {{ data_hoje }}</h3>
    <div class="aula-item" onclick="verDetalhesAula('Aluno X', '14h00')">
      <i class="fas fa-chalkboard-teacher"></i>
      <span>Aula de Matem√°tica</span>
      <span>Kz 1.250,00</span>
    </div>
    <div class="aula-item" onclick="verDetalhesAula('Aluno Y', '16h00')">
      <i class="fas fa-chalkboard-teacher"></i>
      <span>Aula de F√≠sica</span>
      <span>Kz 1.250,00</span>
    </div>
    <!-- Mais aulas aqui -->
  </div>

  <!-- Se√ß√µes din√¢micas -->
  <div id="alunos-disponiveis" class="secao-dinamica">
    <h4>Alunos Dispon√≠veis</h4>
    <div id="lista-alunos-disponiveis"></div>
  </div>

  <div id="meus-alunos" class="secao-dinamica">
    <h4>Meus Alunos</h4>
    <div id="lista-meus-alunos"></div>
  </div>

  <div id="ver-dados" class="secao-dinamica">
    <h4>Meus Dados</h4>
    <p>Email: {{ professor.email }}</p>
    <p>Telefone: {{ professor.telefone }}</p>
    <!-- Outros dados -->
  </div>

  <div id="aulas-semana" class="secao-dinamica">
    <h4>Minhas Aulas da Semana</h4>
    <div id="lista-aulas-semana"></div>
  </div>

  <!-- Navega√ß√£o inferior -->
  <div class="bottom-nav">
    <button onclick="location.href='/perfil_professor'" title="Meu Perfil"><i class="fas fa-user-circle"></i></button>
    <button onclick="location.href='/salarios'" title="Sal√°rios"><i class="fas fa-money-bill-wave"></i></button>
    <button onclick="abrirMenuResumo()" title="Menu"><i class="fas fa-bars"></i></button>
  </div>

  <script>
let saldoVisivel = false;
    function toggleSaldo() {
      const saldo = document.getElementById('saldo');
      saldoVisivel = !saldoVisivel;
      saldo.innerText = saldoVisivel ? "Kz {{ saldo_total }}" : "Kz 00,00";
    }

    function verDetalhesAula(aluno, hora) {
      alert("Aula para: " + aluno + "\nHor√°rio: " + hora + "\nDura√ß√£o: 1h\nValor: Kz 1.250,00");
    }

    function abrirMenuResumo() {
      alert("Bot√µes e fun√ß√µes principais do professor ser√£o listados aqui");
    }
  
  function toggleDados() {
    const div = document.getElementById('dadosSecretos');
    div.style.display = div.style.display === 'block' ? 'none' : 'block';
  }

  function toggleSection(id, fetchFunction) {
    const section = document.getElementById(id);
    if (section.style.display === 'block') {
      section.style.display = 'none';
    } else {
      section.style.display = 'block';
      fetchFunction();
    }
  }

  async function enviarNotificacao(aluno) {
    try {
      const resposta = await fetch("/ativar-notificacao", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          aluno: aluno
        })
      });

      const resultado = await resposta.json();
      alert(resultado.msg || "Notifica√ß√£o enviada!");
    } catch (error) {
      console.error("Erro ao enviar notifica√ß√£o:", error);
      alert("Erro ao enviar notifica√ß√£o.");
    }
  }

  function slugify(text) {
    return text
      .toLowerCase()
      .replace(/\s+/g, '-')       
      .replace(/[^\w\-@.]+/g, '') 
      .replace(/\-\-+/g, '-')     
      .replace(/^-+/, '')         
      .replace(/-+$/, '');        
  }

  async function iniciarChamada(aluno, professorEmail) {
    try {
      await enviarNotificacao(aluno);

      // Registrar a aula no Firebase
      await fetch("/iniciar-aula", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          aluno: aluno,
          professor: professorEmail,
          sala: `${slugify(professorEmail)}-${slugify(aluno)}`
        })
      });

      // ‚úÖ Definir status como "ok"
      await fetch("/definir-status-ok", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ aluno: aluno })
      });

      // Redirecionar para a sala
    window.location.href = `/sala_virtual_professor?email=${encodeURIComponent(professorEmail)}&aluno=${encodeURIComponent(aluno)}`;
    } catch (error) {
      console.error("Erro ao iniciar chamada:", error);
      alert("Erro ao iniciar a chamada.");
    }
  }

let alunoSelecionado = null;

async function listarMeusAlunos() {
  const emailProfessorLogado = "{{ professor.email }}";

  try {
    const res = await fetch(`/meus-alunos-status/${encodeURIComponent(emailProfessorLogado)}`);
    const lista = await res.json();
    const container = document.getElementById('meus-alunos');
    container.innerHTML = '<h2>Meus Alunos</h2>';

    if (lista.length === 0) {
      container.innerHTML += '<p>Nenhum aluno vinculado ainda.</p>';
      return;
    }

    lista.forEach(aluno => {
      const card = document.createElement('div');
      card.className = 'aluno-card';

      const statusClass = aluno.online ? 'online' : 'offline';
      const statusText = aluno.online ? 'Online' : 'Offline';

      card.innerHTML = `
        <div class="aluno-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span><strong>${aluno.nome}</strong> - ${aluno.disciplina}</span>
          <div class="status">
            <span>${statusText}</span>
            <span class="status-dot ${statusClass}"></span>
          </div>
        </div>
      `;

      if (aluno.online) {
        const iniciarBtn = document.createElement('button');
        iniciarBtn.textContent = 'Dar Aula';
        iniciarBtn.className = 'notificar-btn';
        iniciarBtn.onclick = (e) => {
          e.stopPropagation();
          iniciarChamada(aluno.nome, emailProfessorLogado);
        };
        card.appendChild(iniciarBtn);
      }

      const desvincularBtn = document.createElement('button');
      desvincularBtn.textContent = 'Desvincular';
      desvincularBtn.style.marginLeft = '10px';
      desvincularBtn.onclick = (e) => {
        e.stopPropagation();
        desvincularAluno(aluno.nome, emailProfessorLogado);
      };
      card.appendChild(desvincularBtn);

      const horarioBtn = document.createElement('button');
      horarioBtn.textContent = 'Hor√°rio';
      horarioBtn.style.marginLeft = '10px';
      horarioBtn.onclick = (e) => {
        e.stopPropagation();
        alunoSelecionado = aluno.nome;
        abrirCalendario();
      };
      card.appendChild(horarioBtn);

      // ‚úÖ Bot√£o "Aulas dadas"
      const aulasBtn = document.createElement('button');
      aulasBtn.textContent = 'Aulas dadas';
      aulasBtn.style.marginLeft = '10px';
      aulasBtn.onclick = (e) => {
        e.stopPropagation();
        verAulasDadas(aluno.nome);
      };
      card.appendChild(aulasBtn);

      container.appendChild(card); // ‚úÖ Isso deve vir depois de todos os appendChilds
    });

  } catch (error) {
    console.error("Erro ao buscar alunos:", error);
    alert("Erro ao buscar alunos.");
  }
}

async function verAulasDadas(nomeAluno) {
  try {
    const response = await fetch("/ver-aulas", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ aluno: nomeAluno })
    });

    const data = await response.json();

    if (data.erro) {
      alert("Erro: " + data.erro);
      return;
    }

    let mensagem = `Aulas dadas para ${nomeAluno}:\n\n`;
    mensagem += `Total de aulas dadas: ${data.aulas_dadas}\n`;
    mensagem += `Aulas restantes: ${data.restantes}`;

    alert(mensagem);
  } catch (error) {
    console.error("Erro ao buscar aulas dadas:", error);
    alert("Erro ao buscar aulas dadas.");
  }
}

 async function buscarAlunosDisponiveis() {
    const email = "{{ professor.email }}";
    try {
      const res = await fetch(`/alunos-disponiveis/${encodeURIComponent(email)}`);
      const lista = await res.json();
      const container = document.getElementById('alunos-disponiveis');
      container.innerHTML = '<h2>Alunos Dispon√≠veis</h2>';

      if (lista.length === 0) {
        container.innerHTML += '<p>Nenhum aluno dispon√≠vel no momento.</p>';
        return;
      }

      lista.forEach(aluno => {
        const card = document.createElement('div');
        card.className = 'aluno-card';

        const nomeAluno = aluno.nome;
        const disciplina = aluno.disciplina;

        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${nomeAluno}</strong> - ${disciplina}
            </div>
            <button class="notificar-btn" onclick="vincularAluno('${nomeAluno}', '{{ professor.email }}')">
              Vincular
            </button>
          </div>
        `;

        container.appendChild(card);
      });
    } catch (error) {
      console.error("Erro ao buscar alunos dispon√≠veis:", error);
      alert("Erro ao buscar alunos dispon√≠veis.");
    }
  }

  async function vincularAluno(nomeAluno, professorEmail) {
    try {
      const res = await fetch('/vincular-aluno', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          professor_email: professorEmail,
          aluno_nome: nomeAluno
        })
      });

      if (res.ok) {
        alert(`Aluno "${nomeAluno}" vinculado com sucesso!`);
        buscarAlunosDisponiveis();
      } else {
        const erro = await res.json();
        alert(`Erro: ${erro.detail}`);
      }
    } catch (error) {
      console.error('Erro ao vincular aluno:', error);
      alert('Erro interno ao tentar vincular o aluno.');
    }
  }
  
function abrirCalendario() {
  const container = document.getElementById('calendarContainer');
  container.style.display = 'block';
  gerarCalendario();
}

function gerarCalendario() {
  const dias = ['Segunda-feira','Ter√ßa-feira','Quarta-feira','Quinta-feira','Sexta-feira','S√°bado','Domingo'];
  const daySelector = document.getElementById('daySelector');
  const timeSelector = document.getElementById('timeSelector');

  daySelector.innerHTML = '';
  timeSelector.innerHTML = '';

  dias.forEach(dia => {
    const div = document.createElement('div');
    div.textContent = dia;
    div.className = 'day';
    div.onclick = () => {
      document.querySelectorAll('.day').forEach(d => d.classList.remove('active'));
      div.classList.add('active');
      gerarHorarios();
    };
    daySelector.appendChild(div);
  });
}

function gerarHorarios() {
  const timeSelector = document.getElementById('timeSelector');
  timeSelector.innerHTML = '';
  const inicio = 7.5;
  const fim = 20.5;

  for (let h = inicio; h < fim; h++) {
    const horaInicial = `${Math.floor(h)}:${h % 1 ? '30' : '00'}`;
    const horaFinal = `${Math.floor(h + 1)}:${(h + 1) % 1 ? '30' : '00'}`;
    const texto = `${horaInicial} - ${horaFinal}`;
    const div = document.createElement('div');
    div.textContent = texto;
    div.className = 'time';
    div.onclick = () => div.classList.toggle('active');
    timeSelector.appendChild(div);
  }
}

function guardarHorario() {
  const diasSelecionados = Array.from(document.querySelectorAll(".day.active")).map(d => d.textContent);
  const horarios = Array.from(document.querySelectorAll(".time.active")).map(t => t.textContent);

  if (!alunoSelecionado || diasSelecionados.length !== 1 || horarios.length === 0) {
    alert("Selecione um √∫nico dia e pelo menos um hor√°rio.");
    return;
  }

  const dados = {
    aluno: alunoSelecionado,
    dias: diasSelecionados,
    horarios
  };

  fetch("/guardar-horario", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(dados)
  })
    .then(res => res.json())
    .then(data => alert(data.mensagem || data.erro))
    .catch(err => alert("Erro ao guardar hor√°rio: " + err));
}

async function enviarHorario() {
  const diasSelecionados = Array.from(document.querySelectorAll(".day.active")).map(d => d.textContent);
  const horarios = Array.from(document.querySelectorAll(".time.active")).map(t => t.textContent);

  if (!alunoSelecionado || diasSelecionados.length === 0 || horarios.length === 0) {
    alert("Selecione pelo menos um dia e um hor√°rio.");
    return;
  }

  const professorEmail = "{{ professor.email }}";

  const mapaDias = {
    "Segunda-feira": "Seg",
    "Ter√ßa-feira": "Ter",
    "Quarta-feira": "Qua",
    "Quinta-feira": "Qui",
    "Sexta-feira": "Sex",
    "S√°bado": "S√°b",
    "Domingo": "Dom"
  };

  const horario = {};
  diasSelecionados.forEach(dia => {
    const abreviado = mapaDias[dia] || dia;
    horario[abreviado] = horarios;
  });

  const payload = {
    aluno_nome: alunoSelecionado,
    professor_email: professorEmail,
    horario
  };

  try {
    const response = await fetch("/enviar-horario", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (response.ok) {
      alert(`Hor√°rio enviado com sucesso para ${alunoSelecionado}!`);
    } else {
      alert("Erro ao enviar hor√°rio: " + (data.detail || "Erro desconhecido."));
    }
  } catch (e) {
    alert("Erro ao enviar o hor√°rio.");
    console.error(e);
  }
} 
  function toggleDados() {
    const div = document.getElementById("dadosSecretos");
    div.style.display = div.style.display === "none" ? "block" : "none";

    const mensagensDiv = document.getElementById("mensagensAdmin");
    mensagensDiv.style.display = mensagensDiv.style.display === "none" ? "block" : "none";
  }

  async function buscarMensagensProfessor() {
    const email = "{{ professor.email }}".trim().toLowerCase();
    const res = await fetch(`/mensagens-professor/${email}`);
    const dados = await res.json();

    const lista = document.getElementById("listaMensagens");
    lista.innerHTML = "";

    if (dados.mensagens && dados.mensagens.length > 0) {
      dados.mensagens.forEach(msg => {
        const item = document.createElement("li");
        item.style.padding = "10px";
        item.style.borderBottom = "1px solid #ffe082";
        item.innerHTML = `<strong>${msg.data || "Sem data"}:</strong><br>${msg.texto}`;
        lista.appendChild(item);
      });
    } else {
      lista.innerHTML = "<li style='color:#777'>Nenhuma mensagem recebida ainda.</li>";
    }
  }

  // Chama a fun√ß√£o ao carregar a p√°gina
  window.addEventListener("DOMContentLoaded", buscarMensagensProfessor);
</script>
</body>
</html>
