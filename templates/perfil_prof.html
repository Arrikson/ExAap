<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil do Professor</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap Ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    body {
      margin: 0;
      font-family: 'Nunito', sans-serif;
      background: #f4f4f8;
      color: #333;
      padding: 0;
    }

    .top-bar {
      background: linear-gradient(135deg, #00c9ff, #92fe9d);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .top-bar img {
      height: 40px;
    }

    .logout-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: background 0.3s ease;
    }

    .logout-btn:hover {
      background-color: #d32f2f;
    }

    .logout-btn i {
      margin-right: 5px;
    }

    .container {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      font-size: 26px;
    }

    h1 img {
      height: 40px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }

    input, p {
      width: 100%;
      background: #f1f1f1;
      border: none;
      padding: 12px;
      border-radius: 10px;
      box-sizing: border-box;
      font-size: 15px;
    }

    .buttons {
      margin-top: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    .buttons button {
      padding: 14px 20px;
      border: none;
      font-weight: bold;
      background: linear-gradient(135deg, #00c9ff, #92fe9d);
      color: #000;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, background 0.3s ease;
    }

    .buttons button:hover {
      transform: translateY(-5px);
      background: linear-gradient(135deg, #00a0c9, #7cd77b);
    }

    .buttons button:last-child {
      background: linear-gradient(135deg, #ff416c, #ff4b2b);
      color: #fff;
    }

    .buttons button:last-child:hover {
      background: linear-gradient(135deg, #e03b5e, #e24220);
    }

    .dados-secretos {
      display: none;
      background: #f3f3f3;
      padding: 20px;
      border-radius: 16px;
      margin-top: 25px;
    }

    .toggle-btn {
      background-color: #ffc107;
      color: #000;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .toggle-btn:hover {
      background-color: #e0a800;
    }

    .aluno-card {
      background: #e9e9e9;
      color: #000;
      margin-bottom: 10px;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

      .calendar-container {
  margin-top: 30px;
  background: #1e1e2f;
  border-radius: 16px;
  padding: 25px;
  color: #fff;
  display: none;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
}

.day-selector,
.time-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 15px;
}

.day,
.time {
  padding: 12px 20px;
  background-color: #2d2d40;
  border-radius: 10px;
  cursor: pointer;
  user-select: none;
  font-weight: bold;
  color: #ccc;
  transition: 0.3s;
  border: 1px solid transparent;
}

.day:hover,
.time:hover {
  background-color: #3d3d5c;
  color: #fff;
}

.day.active,
.time.active {
  background-color: #00c9ff;
  color: #fff;
  border-color: #00a9e0;
}

.calendar-actions {
  margin-top: 25px;
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  justify-content: center;
}

.calendar-actions button {
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #28a745, #00c853);
  color: white;
  font-size: 15px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.calendar-actions button:hover {
  transform: translateY(-3px);
  background: linear-gradient(135deg, #1f9440, #009c4e);
}

.calendar-actions button:last-child {
  background: linear-gradient(135deg, #007bff, #0056b3);
}

.calendar-actions button:last-child:hover {
  background: linear-gradient(135deg, #005ecb, #00449c);
}
  .aluno-card.selecionado {
  border: 2px solid #28a745;
  background-color: #1f1f1f;
}
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .online { background-color: #28a745; }
    .offline { background-color: #dc3545; }

    @media (max-width: 700px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <img src="/static/logo.png" alt="Logo">
    <form id="logoutForm" method="post" action="/logout_prof">
      <input type="hidden" name="email" value="{{ professor.email }}">
      <button type="submit" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </form>
  </div>

  <div class="container">
    <h1><img src="/static/professor.png" alt="Professor"> Meu Perfil</h1>

    {% if mensagem %}
      <p style="text-align:center; color: #ff9800; font-size: 18px;">{{ mensagem }}</p>
    {% endif %}

    <div class="grid">
      <div>
        <label>Nome Completo</label>
        <input type="text" value="{{professor.nome_completo}}" readonly>

        <label>Nível de Ensino</label>
        <input type="text" value="{{professor.nivel_ensino}}" readonly>

        <label>Área de Formação</label>
        <input type="text" value="{{professor.area_formacao}}" readonly>
      </div>
      <div>
        <label>Telefone</label>
        <input type="text" value="{{professor.telefone}}" readonly>

        <label>Localização</label>
        <input type="text" value="{{professor.localizacao}}" readonly>
      </div>
    </div>

    <button class="toggle-btn" onclick="toggleDados()">Ver mais dados</button>
    <div id="dadosSecretos" class="dados-secretos">
      <p><strong>Email:</strong> {{professor.email}}</p>
      <p><strong>Nome da Mãe:</strong> {{professor.nome_mae}}</p>
      <p><strong>Nome do Pai:</strong> {{professor.nome_pai}}</p>
      <p><strong>Bilhete:</strong> {{professor.bilhete}}</p>
      <p><strong>Senha:</strong> ••••••••••</p>
    </div>

    <div class="buttons">
      <button onclick="toggleSection('meus-alunos', listarMeusAlunos)">Meus Alunos</button>
      <button onclick="toggleSection('alunos-disponiveis', buscarAlunosDisponiveis)">Alunos Disponíveis</button>
      <button onclick="alert('Aulas do Dia')">Aulas do Dia</button>
      <button onclick="alert('Aulas da Semana')">Aulas da Semana</button>
      <button onclick="comecarAula()">Começar Aula</button>
    </div>

    <div id="meus-alunos" style="margin-top: 30px; display: none;"></div>
    <div id="alunos-disponiveis" style="margin-top: 30px; display: none;"></div>

<!-- NOVO CALENDÁRIO ADICIONADO -->
<div id="calendarContainer" style="display:none; padding: 20px; margin-top: 20px; background: #111; color: #fff; border-radius: 10px;">
  <h3>Selecione os horários</h3>
  <div id="daySelector" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;"></div>
  <div id="timeSelector" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;"></div>
  <div class="calendar-actions">
    <button onclick="guardarHorario()" style="margin-right: 10px; padding: 5px 15px; background: #666; color: #fff; border: none; border-radius: 5px;">Guardar</button>
    <button onclick="enviarHorario()" style="padding: 5px 15px; background: #28a745; color: #fff; border: none; border-radius: 5px;">Enviar o horário</button>
  </div>
</div>


<script>
 
  function toggleDados() {
    const div = document.getElementById('dadosSecretos');
    div.style.display = div.style.display === 'block' ? 'none' : 'block';
  }

  function toggleSection(id, fetchFunction) {
    const section = document.getElementById(id);
    if (section.style.display === 'block') {
      section.style.display = 'none';
    } else {
      section.style.display = 'block';
      fetchFunction();
    }
  }

  async function enviarNotificacao(aluno) {
    try {
      const resposta = await fetch("/ativar-notificacao", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          aluno: aluno
        })
      });

      const resultado = await resposta.json();
      alert(resultado.msg || "Notificação enviada!");
    } catch (error) {
      console.error("Erro ao enviar notificação:", error);
      alert("Erro ao enviar notificação.");
    }
  }

  function slugify(text) {
    return text
      .toLowerCase()
      .replace(/\s+/g, '-')       // espaços → hífens
      .replace(/[^\w\-@.]+/g, '') // remove tudo que não for letra, número, hífen, underline, @ ou ponto
      .replace(/\-\-+/g, '-')     // múltiplos hífens → um
      .replace(/^-+/, '')         // remove hífens no início
      .replace(/-+$/, '');        // remove hífens no fim
  }

  async function iniciarChamada(aluno, professorEmail) {
    try {
      await enviarNotificacao(aluno);

      // Registrar a aula no Firebase
      await fetch("/iniciar-aula", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          aluno: aluno,
          professor: professorEmail,
          sala: `${slugify(professorEmail)}-${slugify(aluno)}`
        })
      });

      // ✅ Definir status como "ok"
      await fetch("/definir-status-ok", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ aluno: aluno })
      });

      // Redirecionar para a sala
    window.location.href = `/sala_virtual_professor?email=${encodeURIComponent(professorEmail)}&aluno=${encodeURIComponent(aluno)}`;
    } catch (error) {
      console.error("Erro ao iniciar chamada:", error);
      alert("Erro ao iniciar a chamada.");
    }
  }

async function listarMeusAlunos() {
  const email = "{{ professor.email }}";
  try {
    const res = await fetch(`/meus-alunos-status/${encodeURIComponent(email)}`);
    const lista = await res.json();
    const container = document.getElementById('meus-alunos');
    container.innerHTML = '<h2>Meus Alunos</h2>';

    if (lista.length === 0) {
      container.innerHTML += '<p>Nenhum aluno vinculado ainda.</p>';
      return;
    }

    lista.forEach(aluno => {
      const card = document.createElement('div');
      card.className = 'aluno-card';

      const statusClass = aluno.online ? 'online' : 'offline';
      const statusText = aluno.online ? 'Online' : 'Offline';

      card.innerHTML = `
        <div class="aluno-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span><strong>${aluno.nome}</strong> - ${aluno.disciplina}</span>
          <div class="status">
            <span>${statusText}</span>
            <span class="status-dot ${statusClass}"></span>
          </div>
        </div>
      `;
      // Botão Dar Aula
      if (aluno.online) {
        const iniciarBtn = document.createElement('button');
        iniciarBtn.textContent = 'Dar Aula';
        iniciarBtn.className = 'notificar-btn';
        iniciarBtn.onclick = (e) => {
          e.stopPropagation();
          iniciarChamada(aluno.nome, emailProfessorLogado);
        };
        card.appendChild(iniciarBtn);
      }

      // Botão Desvincular
      const desvincularBtn = document.createElement('button');
      desvincularBtn.textContent = 'Desvincular';
      desvincularBtn.style.marginLeft = '10px';
      desvincularBtn.onclick = (e) => {
        e.stopPropagation();
        desvincularAluno(aluno.nome, emailProfessorLogado);
      };
      card.appendChild(desvincularBtn);

      // Botão Horário
      const horarioBtn = document.createElement('button');
      horarioBtn.textContent = 'Horário';
      horarioBtn.style.marginLeft = '10px';
      horarioBtn.onclick = (e) => {
        e.stopPropagation();
        alunoSelecionado = aluno.nome;
        abrirCalendario();
      };
      card.appendChild(horarioBtn);

      container.appendChild(card);
    });
  } catch (error) {
    console.error("Erro ao buscar alunos:", error);
    alert("Erro ao buscar alunos.");
  }
}

async function desvincularAluno(nomeAluno, professorEmail) {
  if (!confirm(`Tem certeza que deseja desvincular o aluno "${nomeAluno}"?`)) return;
  try {
    const res = await fetch('/desvincular-aluno', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ professor_email: professorEmail, aluno_nome: nomeAluno })
    });

    const resposta = await res.json();
    if (res.ok) {
      alert('Aluno desvinculado com sucesso!');
      listarMeusAlunos();
    } else {
      alert(resposta.detail || 'Erro ao desvincular.');
    }
  } catch (error) {
    console.error('Erro ao desvincular aluno:', error);
    alert('Erro interno ao tentar desvincular o aluno.');
  }
}

// =============== CALENDÁRIO =============== //
function gerarCalendario() {
  const dias = ['Segunda-feira','Terça-feira','Quarta-feira','Quinta-feira','Sexta-feira','Sábado','Domingo'];
  const daySelector = document.getElementById('daySelector');
  const timeSelector = document.getElementById('timeSelector');

  daySelector.innerHTML = '';
  timeSelector.innerHTML = '';

  dias.forEach(dia => {
    const div = document.createElement('div');
    div.textContent = dia;
    div.className = 'day';
    div.onclick = () => {
      div.classList.toggle('active');
      gerarHorarios(dia);
    };
    daySelector.appendChild(div);
  });
}

function gerarHorarios() {
  const timeSelector = document.getElementById('timeSelector');
  timeSelector.innerHTML = '';

  const inicio = 7.5;
  const fim = 20.5;

  for (let h = inicio; h < fim; h++) {
    const horaInicial = `${Math.floor(h)}:${h % 1 ? '30' : '00'}`;
    const horaFinal = `${Math.floor(h + 1)}:${(h + 1) % 1 ? '30' : '00'}`;
    const texto = `${horaInicial} - ${horaFinal}`;
    const div = document.createElement('div');
    div.textContent = texto;
    div.className = 'time';
    div.onclick = () => div.classList.toggle('active');
    timeSelector.appendChild(div);
  }
}

function abrirCalendario() {
  const container = document.getElementById('calendarContainer');
  container.style.display = container.style.display === 'block' ? 'none' : 'block';
  gerarCalendario();
}

function guardarHorario() {
  const aluno = alunoSelecionado;
  const diasSelecionados = Array.from(document.querySelectorAll(".day.active")).map(d => d.textContent);
  const horarios = Array.from(document.querySelectorAll(".time.active")).map(t => t.textContent);

  if (!aluno || diasSelecionados.length === 0 || horarios.length === 0) {
    alert("Selecione o aluno, os dias e pelo menos um horário.");
    return;
  }

  const dados = {
    aluno,
    dias: diasSelecionados,
    horarios
  };

  fetch("/guardar-horario", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(dados)
  })
  .then(res => res.json())
  .then(data => alert(data.mensagem || data.erro))
  .catch(err => alert("Erro ao guardar horário: " + err));
}

async function enviarHorario() {
  const diasSelecionados = Array.from(document.querySelectorAll('.day.active')).map(d => d.textContent);
  const horariosSelecionados = Array.from(document.querySelectorAll('.time.active')).map(t => t.textContent);

  if (diasSelecionados.length === 0 || horariosSelecionados.length === 0) {
    alert("Selecione pelo menos um dia e um horário");
    return;
  }

  const professorEmail = typeof emailProfessorLogado !== "undefined"
    ? emailProfessorLogado
    : "{{ professor.email }}";

  if (!professorEmail || !alunoSelecionado) {
    alert("Erro: aluno ou professor não identificados.");
    return;
  }

  const mapaDias = {
    "Segunda-feira": "Seg",
    "Terça-feira": "Ter",
    "Quarta-feira": "Qua",
    "Quinta-feira": "Qui",
    "Sexta-feira": "Sex",
    "Sábado": "Sáb",
    "Domingo": "Dom"
  };

  const horario = {};
  diasSelecionados.forEach(dia => {
    const abreviado = mapaDias[dia] || dia;
    horario[abreviado] = horariosSelecionados;
  });

  const payload = {
    aluno_nome: alunoSelecionado,
    professor_email: professorEmail,
    horario
  };

  try {
    const response = await fetch('/enviar-horario', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (response.ok) {
      alert(`Horário enviado com sucesso para ${alunoSelecionado}!`);
    } else {
      alert("Erro ao enviar horário: " + (data.detail || "Erro desconhecido"));
    }
  } catch (e) {
    alert("Erro ao enviar o horário.");
    console.error(e);
  }
}
  
// INSERIR BOTÃO "HORÁRIO" AO LADO DO "DESVINCULAR"
const observer = new MutationObserver(() => {
  document.querySelectorAll('.aluno-card').forEach(card => {
    if (!card.querySelector('.btn-horario')) {
      const btn = document.createElement('button');
      btn.textContent = 'Horário';
      btn.className = 'btn-horario';
      btn.style.marginLeft = '10px';
      btn.onclick = abrirCalendario;
      const desvincular = card.querySelector('button:nth-of-type(2)');
      desvincular.insertAdjacentElement('afterend', btn);
    }
  });
});
observer.observe(document.getElementById('meus-alunos'), { childList: true, subtree: true });
</script>
</body>
</html>
