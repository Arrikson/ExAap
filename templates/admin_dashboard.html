<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>Painel Administrativo | SabApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- AdminLTE + Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
  /* MAPA */
  #mapAngola { 
    height: 350px; 
    border-radius: 10px;
  }

/* ===============================
   OVERLAY LISTA DE ALUNOS
================================ */

.alunos-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.55);

  display: none;
  justify-content: center;
  align-items: center;

  z-index: 9999;
}

/* ===============================
   BLOCO DE LISTAGEM DE ALUNOS
================================ */

.alunos-container {
  width: 90%;
  max-width: 1150px;
  max-height: 85vh;
  overflow-y: auto;

  background: #ffffff;
  border-radius: 14px;
  padding: 22px;

  box-shadow: 0 15px 40px rgba(0,0,0,0.25);

  animation: zoomIn .25s ease;
  transition: all .3s ease;
}

@keyframes zoomIn {
  from {
    transform: scale(.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

.dark-mode .alunos-container {
  background: #1f2d3d;
}

/* ===============================
   T√çTULO
================================ */

.alunos-title {
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 15px;
}

/* ===============================
   TABELA
================================ */

table.tabela-alunos {
  width: 100%;
  border-collapse: collapse;
}

table.tabela-alunos thead {
  background: linear-gradient(45deg,#007bff,#0056b3);
  color: white;
}

table.tabela-alunos th,
table.tabela-alunos td {
  padding: 11px;
  border-bottom: 1px solid #e1e1e1;
  vertical-align: middle;
}

.dark-mode table.tabela-alunos th,
.dark-mode table.tabela-alunos td {
  border-color: #3b3b3b;
}

table.tabela-alunos tbody tr:hover {
  background: rgba(0,123,255,0.08);
}

.dark-mode table.tabela-alunos tbody tr:hover {
  background: rgba(255,255,255,0.06);
}

/* ===============================
   STATUS VISUAL
================================ */

.status-online {
  color: #28a745;
  font-weight: bold;
}

.status-offline {
  color: #dc3545;
  font-weight: bold;
}

.status-vinculado {
  background: #28a745;
  color: white;
  padding: 4px 9px;
  border-radius: 8px;
  font-size: 12px;
}

.status-nao-vinculado {
  background: #dc3545;
  color: white;
  padding: 4px 9px;
  border-radius: 8px;
  font-size: 12px;
}

/* ===============================
   BOT√ïES
================================ */

.btn-remover {
  background: #dc3545;
  color: white;
  border: none;
  padding: 5px 12px;
  border-radius: 7px;
  cursor: pointer;
  transition: .2s;
}

.btn-remover:hover {
  opacity: .8;
}

/* ===============================
   LOADING
================================ */

.loader-alunos {
  text-align: center;
  padding: 25px;
  font-weight: bold;
  font-size: 15px;
  color: #007bff;
}

/* ===============================
   RESPONSIVO
================================ */

@media (max-width: 768px) {

  .alunos-container {
    width: 95%;
    max-height: 90vh;
    padding: 15px;
  }

  table.tabela-alunos thead {
    display: none;
  }

  table.tabela-alunos tr {
    display: block;
    margin-bottom: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 5px;
  }

  .dark-mode table.tabela-alunos tr {
    border-color: #444;
  }

  table.tabela-alunos td {
    display: flex;
    justify-content: space-between;
    padding: 8px;
  }

  table.tabela-alunos td::before {
    content: attr(data-label);
    font-weight: 600;
  }
}

</style>


</head>

<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu"><i class="fas fa-bars"></i></a>
      </li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></a>
      </li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">

    <a href="#" class="brand-link text-center">
      <span class="brand-text font-weight-light">Administra√ß√£o SabApp</span>
    </a>

    <!-- MENU -->
    <div class="sidebar">
      <nav class="mt-3">
        <ul class="nav nav-pills nav-sidebar flex-column" 
            data-widget="treeview" role="menu" data-accordion="false">

          <!-- ALUNOS -->
          <li class="nav-item has-treeview">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-user-graduate"></i>
              <p>
                Alunos
                <i class="right fas fa-angle-left"></i>
              </p>
            </a>

            <ul class="nav nav-treeview">

 <li class="nav-item">
  <a href="#" class="nav-link"
     onclick="event.preventDefault(); carregarAlunos();">
    <i class="far fa-circle nav-icon"></i>
    <p>Alunos Cadastrados</p>
  </a>
</li>

<!-- ===============================
     OVERLAY LISTAGEM DE ALUNOS
================================ -->

<div class="alunos-overlay" id="overlayAlunos">

  <div class="alunos-container">

    <!-- Cabe√ßalho -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">

      <div class="alunos-title">
        üìã Alunos Cadastrados
      </div>

      <button class="btn btn-secondary"
              onclick="fecharAlunos()">
        Fechar
      </button>

    </div>

    <!-- Loader / tabela -->
    <div id="listaAlunos">

      <table class="tabela-alunos" id="tabela-alunos">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Disciplina</th>
            <th>Online</th>
            <th>V√≠nculo</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>

  </div>

</div>

  <li class="nav-item">
    <a href="#" class="nav-link"
       onclick="event.preventDefault(); carregarAlunosDisponiveis();">
      <i class="far fa-circle nav-icon"></i>
      <p>Alunos sem v√≠nculo</p>
    </a>
  </li>

</ul>

          <!-- PROFESSORES -->
          <li class="nav-item has-treeview">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-chalkboard-teacher"></i>
              <p>
                Professores
                <i class="right fas fa-angle-left"></i>
              </p>
            </a>

            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a href="/professores-online" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Professores Online</p>
                </a>
              </li>
            </ul>
          </li>

          <!-- FINAN√áAS -->
          <li class="nav-item has-treeview">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-coins"></i>
              <p>
                Finan√ßas
                <i class="right fas fa-angle-left"></i>
              </p>
            </a>

            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a href="/controle-pagamento-alunos" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Controle de pagamentos de alunos</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="/controle-pagamento-professores" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Controle de pagamento de professores</p>
                </a>
              </li>
            </ul>
          </li>

        </ul>
      </nav>
    </div>
  </aside>

  <!-- Conte√∫do -->
  <div class="content-wrapper">
    <section class="content pt-3">
      <div class="container-fluid">

        <!-- CARDS -->
        <div class="row">

          <div class="col-lg-3 col-6">
            <div class="small-box bg-info">
              <div class="inner">
                <h3 id="total-alunos">0</h3>
                <p>Alunos</p>
              </div>
              <div class="icon"><i class="fas fa-user-graduate"></i></div>
            </div>
          </div>

          <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
              <div class="inner">
                <h3 id="total-professores">0</h3>
                <p>Professores</p>
              </div>
              <div class="icon"><i class="fas fa-chalkboard-teacher"></i></div>
            </div>
          </div>

          <div class="col-lg-3 col-6">
            <div class="small-box bg-warning">
              <div class="inner">
                <h3 id="chamadas-ativas">0</h3>
                <p>Aulas Ativas</p>
              </div>
              <div class="icon"><i class="fas fa-video"></i></div>
            </div>
          </div>

          <div class="col-lg-3 col-6">
            <div class="small-box bg-danger">
              <div class="inner">
                <h3 id="alunos-nao-vinculados">0</h3>
                <p>Alunos N√£o Vinculados</p>
              </div>
              <div class="icon"><i class="fas fa-unlink"></i></div>
            </div>
          </div>

        </div>

        <!-- GR√ÅFICO + MAPA -->
        <div class="row">

          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Resumo Geral</h3>
              </div>
              <div class="card-body">
                <canvas id="grafico"></canvas>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Mapa de Angola</h3>
              </div>
              <div class="card-body">
                <div id="mapAngola"></div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </section>
  </div>

  <footer class="main-footer text-center">
    <strong>Todos os Direitos reservados √† SabApp</strong>
  </footer>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
}

// üìä BUSCAR ESTAT√çSTICAS
fetch("/estatisticas-dashboard")
  .then(res => res.json())
  .then(dados => {

    document.getElementById("total-alunos").innerText = dados.alunos.total;
    document.getElementById("total-professores").innerText = dados.professores.total;
    document.getElementById("chamadas-ativas").innerText = dados.chamadas.em_andamento;
    document.getElementById("alunos-nao-vinculados").innerText = dados.alunos.nao_vinculados;

    new Chart(document.getElementById("grafico"), {
      type: "doughnut",
      data: {
        labels: [
          "Alunos Online",
          "Alunos Offline",
          "Vinculados",
          "N√£o Vinculados"
        ],
        datasets: [{
          data: [
            dados.alunos.online,
            dados.alunos.offline,
            dados.alunos.vinculados,
            dados.alunos.nao_vinculados
          ]
        }]
      }
    });
  });

// üó∫Ô∏è MAPA
const map = L.map('mapAngola').setView([-11.2027, 17.8739], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([-8.839, 13.289]).addTo(map).bindPopup("Luanda");

async function carregarAlunos() {

  const overlay = document.getElementById("overlayAlunos");
  const container = document.getElementById("listaAlunos");
  const tbody = document.querySelector("#tabela-alunos tbody");

  // abre o modal
  overlay.style.display = "flex";

  // mostra loading
  container.innerHTML = `
    <div class="loader-alunos">
      Carregando alunos...
    </div>
  `;

  try {

    const res = await fetch("/listar-alunos");

    if (!res.ok) {
      container.innerHTML = `
        <div class="loader-alunos" style="color:red">
          Erro ao buscar alunos
        </div>
      `;
      return;
    }

    const alunos = await res.json();

    if (!tbody) {
      console.error("Tabela #tabela-alunos n√£o encontrada");
      return;
    }

    tbody.innerHTML = "";

    if (alunos.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;font-weight:bold">
            Nenhum aluno cadastrado
          </td>
        </tr>
      `;
      return;
    }

    alunos.forEach(a => {

      tbody.innerHTML += `
        <tr>
          <td data-label="Nome">${a.nome}</td>
          <td data-label="Disciplina">${a.disciplina}</td>

          <td data-label="Status"
              class="${a.online ? 'status-online' : 'status-offline'}">
            ${a.online ? "Online" : "Offline"}
          </td>

          <td data-label="Vinculado">
            <span class="${a.vinculado ? 'status-vinculado' : 'status-nao-vinculado'}">
              ${a.vinculado ? "Sim" : "N√£o"}
            </span>
          </td>

          <td data-label="A√ß√µes">
            <button class="btn-remover"
              onclick="removerAluno('${a.nome}')">
              Remover
            </button>
          </td>
        </tr>
      `;
    });

  } catch (err) {

    console.error("Erro JS:", err);

    container.innerHTML = `
      <div class="loader-alunos" style="color:red">
        Erro inesperado ao carregar alunos
      </div>
    `;

  }

}

  async function carregarAlunosDisponiveis() {
    const res = await fetch("/alunos-nao-vinculados");
    const dados = await res.json();
    const tbody = document.querySelector("#tabela-disponiveis tbody");
    tbody.innerHTML = "";
    dados.forEach(aluno => {
      tbody.innerHTML += `
        <tr><td>${aluno.nome}</td><td>${aluno.disciplina}</td></tr>
      `;
    });
  }
  
</script>

</body>
</html>


