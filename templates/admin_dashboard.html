<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>Painel Administrativo | SabApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- AdminLTE + Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
  /* MAPA */
  #mapAngola { 
    height: 350px; 
    border-radius: 10px;
  }

/* ===============================
   OVERLAY LISTA DE ALUNOS
================================ */

.alunos-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.55);

  display: none;
  justify-content: center;
  align-items: center;

  z-index: 9999;
}

/* ===============================
   BLOCO DE LISTAGEM DE ALUNOS
================================ */

.alunos-container {
  width: 90%;
  max-width: 1150px;
  max-height: 85vh;
  overflow-y: auto;

  background: #ffffff;
  border-radius: 14px;
  padding: 22px;

  box-shadow: 0 15px 40px rgba(0,0,0,0.25);

  animation: zoomIn .25s ease;
  transition: all .3s ease;
}

@keyframes zoomIn {
  from {
    transform: scale(.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

.dark-mode .alunos-container {
  background: #1f2d3d;
}

/* ===============================
   T√çTULO
================================ */

.alunos-title {
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 15px;
}

/* ===============================
   TABELA
================================ */

table.tabela-alunos {
  width: 100%;
  border-collapse: collapse;
}

table.tabela-alunos thead {
  background: linear-gradient(45deg,#007bff,#0056b3);
  color: white;
}

table.tabela-alunos th,
table.tabela-alunos td {
  padding: 11px;
  border-bottom: 1px solid #e1e1e1;
  vertical-align: middle;
}

.dark-mode table.tabela-alunos th,
.dark-mode table.tabela-alunos td {
  border-color: #3b3b3b;
}

table.tabela-alunos tbody tr:hover {
  background: rgba(0,123,255,0.08);
}

.dark-mode table.tabela-alunos tbody tr:hover {
  background: rgba(255,255,255,0.06);
}

/* ===============================
   STATUS VISUAL
================================ */

.status-online {
  color: #28a745;
  font-weight: bold;
}

.status-offline {
  color: #dc3545;
  font-weight: bold;
}

.status-vinculado {
  background: #28a745;
  color: white;
  padding: 4px 9px;
  border-radius: 8px;
  font-size: 12px;
}

.status-nao-vinculado {
  background: #dc3545;
  color: white;
  padding: 4px 9px;
  border-radius: 8px;
  font-size: 12px;
}

/* ===============================
   BOT√ïES
================================ */

.btn-remover {
  background: #dc3545;
  color: white;
  border: none;
  padding: 5px 12px;
  border-radius: 7px;
  cursor: pointer;
  transition: .2s;
}

.btn-remover:hover {
  opacity: .8;
}

/* ===============================
   LOADING
================================ */

.loader-alunos {
  text-align: center;
  padding: 25px;
  font-weight: bold;
  font-size: 15px;
  color: #007bff;
}

/* ===============================
   RESPONSIVO
================================ */

@media (max-width: 768px) {

  .alunos-container {
    width: 95%;
    max-height: 90vh;
    padding: 15px;
  }

  table.tabela-alunos thead {
    display: none;
  }

  table.tabela-alunos tr {
    display: block;
    margin-bottom: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 5px;
  }

  .dark-mode table.tabela-alunos tr {
    border-color: #444;
  }

  table.tabela-alunos td {
    display: flex;
    justify-content: space-between;
    padding: 8px;
  }

  table.tabela-alunos td::before {
    content: attr(data-label);
    font-weight: 600;
  }
}

/* ===============================
   OVERLAY ALUNOS DISPON√çVEIS
================================ */

.alunos-disponiveis-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.55);

  display: none;
  justify-content: center;
  align-items: center;

  z-index: 9999;
}

/* ===============================
   CONTAINER
================================ */

.alunos-disponiveis-container {
  width: 90%;
  max-width: 1050px;
  max-height: 85vh;
  overflow-y: auto;

  background: #ffffff;
  border-radius: 14px;
  padding: 22px;

  box-shadow: 0 15px 40px rgba(0,0,0,0.25);

  animation: zoomIn .25s ease;
}

.dark-mode .alunos-disponiveis-container {
  background: #1f2d3d;
}

/* ===============================
   TABELA
================================ */

table.tabela-disponiveis {
  width: 100%;
  border-collapse: collapse;
}

table.tabela-disponiveis thead {
  background: linear-gradient(45deg,#17a2b8,#0f6674);
  color: white;
}

table.tabela-disponiveis th,
table.tabela-disponiveis td {
  padding: 11px;
  border-bottom: 1px solid #e1e1e1;
}

.dark-mode table.tabela-disponiveis th,
.dark-mode table.tabela-disponiveis td {
  border-color: #3b3b3b;
}

table.tabela-disponiveis tbody tr:hover {
  background: rgba(23,162,184,0.12);
}

/* ===============================
   STATUS
================================ */

.status-disponivel {
  color: #17a2b8;
  font-weight: bold;
}

/* ===============================
   LOADING
================================ */

.loader-disponiveis {
  text-align: center;
  padding: 25px;
  font-weight: bold;
  font-size: 15px;
  color: #17a2b8;
}

/* ===============================
   MENU PROFESSORES ONLINE
================================ */

.nav-treeview .nav-link.prof-online-btn {
  border-left: 3px solid transparent;
  transition: .2s;
}

.nav-treeview .nav-link.prof-online-btn:hover {
  background: rgba(0,123,255,.08);
  border-left-color: #007bff;
}

.dark-mode .nav-treeview .nav-link.prof-online-btn:hover {
  background: rgba(255,255,255,.05);
}

/* ===============================
   OVERLAY PROFESSORES
================================ */

.professores-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* ===============================
   CONTAINER
================================ */

.professores-container {
  background: white;
  border-radius: 14px;
  padding: 20px;
  width: 95%;
  max-width: 900px;
  max-height: 80vh;          /* limita altura */
  box-shadow: 0 10px 40px rgba(0,0,0,.25);
  position: relative;
  display: flex;
  flex-direction: column;
}

.dark-mode .professores-container {
  background: #1f2d3d;
}

/* ===============================
   BOT√ïES SCROLL
================================ */

.scroll-btn {
  position: absolute;
  right: 10px;
  width: 35px;
  height: 35px;
  border: none;
  border-radius: 50%;
  background: rgba(0,123,255,0.8);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  transition: .2s;
  z-index: 10;
}

.scroll-btn:hover {
  background: #007bff;
}

.scroll-up {
  top: 10px;
}

.scroll-down {
  bottom: 10px;
}

/* ===============================
   TABELA
================================ */

table.tabela-professores {
  width: 100%;
  border-collapse: collapse;
  overflow-y: auto;
  flex: 1;                      
  display: block;
}

table.tabela-professores thead {
  background: linear-gradient(45deg,#17a2b8,#117a8b);
  color: white;
  display: table;
  width: 100%;
  table-layout: fixed;
}

table.tabela-professores tbody {
  display: block;
  max-height: calc(80vh - 120px); /* altura da tabela, ajustando espa√ßo de header e bot√µes */
  overflow-y: auto;
  width: 100%;
}

table.tabela-professores th,
table.tabela-professores td {
  padding: 11px;
  border-bottom: 1px solid #ddd;
  text-align: left;
  width: 20%; /* ajusta colunas */
}

.dark-mode table.tabela-professores td {
  border-color: #444;
}

/* ===============================
   STATUS
================================ */

.prof-online {
  color: #28a745;
  font-weight: bold;
}

.prof-offline {
  color: #dc3545;
  font-weight: bold;
}

/* ===============================
   BOT√ïES REMOVER
================================ */

.btn-prof-remover {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 7px;
  cursor: pointer;
}

.btn-prof-remover:hover {
  opacity: .8;
}

/* ===============================
   RESPONSIVO
================================ */

@media(max-width:768px){

  table.tabela-professores thead{display:none}

  table.tabela-professores tr{
    display:block;
    margin-bottom:10px;
    border:1px solid #ddd;
    border-radius:8px;
    padding:6px;
  }

  table.tabela-professores td{
    display:flex;
    justify-content:space-between;
  }

  table.tabela-professores td::before{
    content:attr(data-label);
    font-weight:600;
  }
}

/* ================================
   SE√á√ïES
================================ */
.secao {
    display: none;
    animation: fadeIn .3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ================================
   STATUS
================================ */

.status-circulo {
    display: inline-block;
    width: 11px;
    height: 11px;
    border-radius: 50%;
    margin-right: 6px;
}

.status-verde {
    background: #28a745;
    color: #28a745;
}

.status-vermelho {
    background: #dc3545;
    color: #dc3545;
}

/* ================================
   TABELAS
================================ */

#tabela-pagamentos,
#tabela-pagamentos-prof {
    font-size: 14px;
}

.table thead th {
    background: #f4f6f9;
    font-weight: 600;
}

.dark-mode .table thead th {
    background: #1f2d3d;
}

.table tbody tr:hover {
    background: rgba(0,0,0,.04);
}

/* ================================
   BOT√ïES
================================ */

.table button {
    font-size: 12px;
    font-weight: 600;
    transition: .2s;
}

.table button:hover {
    transform: scale(1.05);
    opacity: .9;
}

/* ================================
   DETALHES (ALUNO / PROF)
================================ */

#detalhes-aluno,
#detalhes-prof {
    border-left: 5px solid #007bff;
    box-shadow: 0 3px 12px rgba(0,0,0,.1);
}

/* ======================================
   OVERLAY FINAN√áAS
====================================== */

.finance-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* ======================================
   CONTAINER FINAN√áAS
====================================== */

.finance-container {
  width: 95%;
  max-width: 1150px;
  max-height: 85vh;
  overflow-y: auto;

  background: #fff;
  border-radius: 14px;
  padding: 22px;

  box-shadow: 0 15px 40px rgba(0,0,0,.25);
  animation: zoomIn .25s ease;
}

.dark-mode .finance-container {
  background: #1f2d3d;
}

/* ======================================
   T√çTULO
====================================== */

.finance-title {
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 15px;
}

/* ======================================
   TABELAS FINAN√áAS
====================================== */

table.tabela-finance {
  width: 100%;
  border-collapse: collapse;
}

table.tabela-finance thead {
  background: linear-gradient(45deg,#007bff,#0056b3);
  color: white;
}

table.tabela-finance th,
table.tabela-finance td {
  padding: 11px;
  border-bottom: 1px solid #e1e1e1;
  vertical-align: middle;
}

.dark-mode table.tabela-finance th,
.dark-mode table.tabela-finance td {
  border-color: #3b3b3b;
}

table.tabela-finance tbody tr:hover {
  background: rgba(0,123,255,.08);
}

.dark-mode table.tabela-finance tbody tr:hover {
  background: rgba(255,255,255,.06);
}

/* ======================================
   STATUS
====================================== */

.status-circulo {
  width: 11px;
  height: 11px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 6px;
}

.status-verde { background:#28a745 }
.status-vermelho { background:#dc3545 }

/* ======================================
   BOT√ïES
====================================== */

.tabela-finance button {
  font-size: 12px;
  font-weight: 600;
  transition: .2s;
}

.tabela-finance button:hover {
  transform: scale(1.05);
  opacity: .9;
}

/* ======================================
   LOADING
====================================== */

.loader-finance {
  text-align: center;
  padding: 25px;
  font-weight: bold;
  font-size: 15px;
  color: #007bff;
}

/* ======================================
   RESPONSIVO
====================================== */

@media(max-width:768px){

  table.tabela-finance thead {
    display: none;
  }

  table.tabela-finance tr {
    display: block;
    margin-bottom: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 6px;
  }

  .dark-mode table.tabela-finance tr {
    border-color: #444;
  }

  table.tabela-finance td {
    display: flex;
    justify-content: space-between;
    padding: 8px;
  }

  table.tabela-finance td::before {
    content: attr(data-label);
    font-weight: 600;
  }

  table.tabela-finance button {
    width: 100%;
    margin-top: 5px;
  }
}

/* ======================================
   DETALHES FINANCEIROS
====================================== */

.finance-detalhes {
  border-left: 5px solid #007bff;
  box-shadow: 0 3px 12px rgba(0,0,0,.1);
  margin-top: 15px;
}

/* ======================================
   DIVISOR
====================================== */

.finance-divider {
  height: 3px;
  background: linear-gradient(to right,#007bff,#28a745);
  margin: 15px 0;
  border-radius: 5px;
}

</style>


</head>

<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

<!-- =====================================
            NAVBAR
===================================== -->
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
  <ul class="navbar-nav">
    <li class="nav-item">
      <a class="nav-link" data-widget="pushmenu"><i class="fas fa-bars"></i></a>
    </li>
  </ul>

  <ul class="navbar-nav ml-auto">
    <li class="nav-item">
      <a class="nav-link" onclick="toggleDarkMode()">
        <i class="fas fa-moon"></i>
      </a>
    </li>
  </ul>
</nav>

<!-- =====================================
            SIDEBAR
===================================== -->
<aside class="main-sidebar sidebar-dark-primary elevation-4">

<a href="#" class="brand-link text-center">
  <span class="brand-text font-weight-light">Administra√ß√£o SabApp</span>
</a>

<div class="sidebar">
<nav class="mt-3">

<ul class="nav nav-pills nav-sidebar flex-column"
    data-widget="treeview" role="menu" data-accordion="false">

<!-- ================= MENU ALUNOS ================= -->

<li class="nav-item has-treeview">
<a href="#" class="nav-link">
  <i class="nav-icon fas fa-user-graduate"></i>
  <p>Alunos <i class="right fas fa-angle-left"></i></p>
</a>

<ul class="nav nav-treeview">

<li class="nav-item">
<a href="#" class="nav-link"
   onclick="event.preventDefault(); carregarAlunos();">
<i class="far fa-circle nav-icon"></i>
<p>Alunos Cadastrados</p>
</a>
</li>

<li class="nav-item">
<a href="#" class="nav-link"
   onclick="event.preventDefault(); carregarAlunosDisponiveis();">
<i class="far fa-circle nav-icon"></i>
<p>Alunos sem v√≠nculo</p>
</a>
</li>

</ul>
</li>

<!-- ================= MENU PROFESSORES ================= -->

<li class="nav-item has-treeview">
<a href="#" class="nav-link">
  <i class="nav-icon fas fa-chalkboard-teacher"></i>
  <p>Professores <i class="right fas fa-angle-left"></i></p>
</a>

<ul class="nav nav-treeview">

<li class="nav-item">
<a href="#" class="nav-link"
   onclick="event.preventDefault(); carregarProfessores();">
<i class="far fa-circle nav-icon"></i>
<p>Professores Online</p>
</a>
</li>

</ul>
</li>

<!-- ================= MENU FINAN√áAS ================= -->
<li class="nav-item has-treeview">
  <a href="#" class="nav-link">
    <i class="nav-icon fas fa-coins"></i>
    <p>Finan√ßas <i class="right fas fa-angle-left"></i></p>
  </a>

  <ul class="nav nav-treeview">
    <li class="nav-item">
      <a href="#" class="nav-link"
         onclick="event.preventDefault(); mostrarSecao('secao-pagamentos'); carregarPagamentos();">
        <i class="far fa-circle nav-icon"></i>
        <p>Pagamento de Alunos</p>
      </a>
    </li>

    <li class="nav-item">
      <a href="#" class="nav-link"
         onclick="event.preventDefault(); mostrarSecao('secao-prof'); carregarPagamentosProf();">
        <i class="far fa-circle nav-icon"></i>
        <p>Pagamento de Professores</p>
      </a>
    </li>
  </ul>
</li>

</ul>
</nav>
</div>
</aside>

<!-- =====================================
        CONTENT WRAPPER
===================================== -->
<div class="content-wrapper">
  <section class="content pt-3">

    <!-- ================= PAGAMENTO ALUNOS ================= -->
    <section class="content secao finance-overlay" id="secao-pagamentos">
      <div class="finance-container">
        <h3 class="finance-title">üí∞ Pagamento de Alunos</h3>
        <table class="table tabela-finance" id="tabela-pagamentos">
          <thead>
            <tr>
              <th>Aluno</th>
              <th>Status</th>
              <th>D√≠vida</th>
              <th>√öltimo Pagamento</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ================= DETALHES ALUNO ================= -->
    <div id="detalhes-aluno" class="finance-detalhes finance-container" style="display:none">
      <h4 id="nome-aluno"></h4>
      <table class="table tabela-finance table-sm">
        <thead>
          <tr>
            <th>M√™s</th>
            <th>Ano</th>
            <th>Valor</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tabela-meses"></tbody>
      </table>
    </div>

    <!-- ================= PAGAMENTO PROFESSORES ================= -->
    <section class="content secao finance-overlay" id="secao-prof">
      <div class="finance-container">
        <h3 class="finance-title">üë®‚Äçüè´ Pagamento de Professores</h3>
        <table class="table tabela-finance" id="tabela-pagamentos-prof">
          <thead>
            <tr>
              <th>Professor</th>
              <th>Status</th>
              <th>Saldo Atual</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ================= DETALHES PROFESSOR ================= -->
    <div id="detalhes-prof" class="finance-detalhes finance-container" style="display:none">
      <h4 id="nome-prof"></h4>
      <p>Saldo Atual: <strong id="saldo-prof"></strong></p>
      <table class="table tabela-finance table-sm">
        <thead>
          <tr>
            <th>M√™s</th>
            <th>Data</th>
            <th>Valor</th>
            <th>Email</th>
            <th>Status</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tabela-meses"></tbody>
      </table>
    </div>

  </section>
</div>

</div>

<!-- =====================================
                FOOTER
===================================== -->

<footer class="main-footer text-center">
<strong>Direitos reservados √† SabApp 2026</strong>
</footer>

</div>

<!-- =====================================
                SCRIPTS
===================================== -->

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
}

// üìä BUSCAR ESTAT√çSTICAS
fetch("/estatisticas-dashboard")
  .then(res => res.json())
  .then(dados => {

    document.getElementById("total-alunos").innerText = dados.alunos.total;
    document.getElementById("total-professores").innerText = dados.professores.total;
    document.getElementById("chamadas-ativas").innerText = dados.chamadas.em_andamento;
    document.getElementById("alunos-nao-vinculados").innerText = dados.alunos.nao_vinculados;

    new Chart(document.getElementById("grafico"), {
      type: "doughnut",
      data: {
        labels: [
          "Alunos Online",
          "Alunos Offline",
          "Vinculados",
          "N√£o Vinculados"
        ],
        datasets: [{
          data: [
            dados.alunos.online,
            dados.alunos.offline,
            dados.alunos.vinculados,
            dados.alunos.nao_vinculados
          ]
        }]
      }
    });
  });

// üó∫Ô∏è MAPA
const map = L.map('mapAngola').setView([-11.2027, 17.8739], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([-8.839, 13.289]).addTo(map).bindPopup("Luanda");

async function carregarAlunos() {

  const overlay = document.getElementById("overlayAlunos");
  const tbody = document.querySelector("#tabela-alunos tbody");

  if (!overlay || !tbody) {
    console.error("Overlay ou tabela n√£o encontrados");
    return;
  }

  // abre modal
  overlay.style.display = "flex";

  // loading inicial
  tbody.innerHTML = `
    <tr>
      <td colspan="5" class="loader-alunos">
        Carregando alunos...
      </td>
    </tr>
  `;

  try {

    const res = await fetch("/listar-alunos");

    if (!res.ok) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="loader-alunos" style="color:red">
            Erro ao buscar alunos
          </td>
        </tr>
      `;
      return;
    }

    let alunos = await res.json();

    // ‚úÖ FILTRA NOMES VAZIOS / NULL
    alunos = alunos.filter(a =>
      a &&
      a.nome &&
      a.nome.toString().trim() !== ""
    );

    tbody.innerHTML = "";

    if (!alunos.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;font-weight:bold">
            Nenhum aluno v√°lido encontrado
          </td>
        </tr>
      `;
      return;
    }

    alunos.forEach(a => {

      const nome = a.nome?.toString().trim() || "‚Äî";
      const disciplina = a.disciplina || "‚Äî";

      tbody.innerHTML += `
        <tr>
          <td data-label="Nome">${nome}</td>
          <td data-label="Disciplina">${disciplina}</td>

          <td data-label="Status"
              class="${a.online ? 'status-online' : 'status-offline'}">
            ${a.online ? "Online" : "Offline"}
          </td>

          <td data-label="Vinculado">
            <span class="${a.vinculado ? 'status-vinculado' : 'status-nao-vinculado'}">
              ${a.vinculado ? "Sim" : "N√£o"}
            </span>
          </td>

          <td data-label="A√ß√µes">
            <button class="btn-remover"
              onclick="removerAluno('${nome}')">
              Remover
            </button>
          </td>
        </tr>
      `;
    });

  } catch (err) {

    console.error("Erro JS:", err);

    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="loader-alunos" style="color:red">
          Erro inesperado
        </td>
      </tr>
    `;
  }

}
function fecharAlunos() {
  const overlay = document.getElementById("overlayAlunos");

  if (overlay) {
    overlay.style.display = "none";
  }
}
  
  async function carregarAlunosDisponiveis() {

  const overlay = document.getElementById("overlayDisponiveis");
  const tbody = document.querySelector("#tabela-disponiveis tbody");

  if (!overlay || !tbody) {
    console.error("Overlay ou tabela dispon√≠veis n√£o encontrados");
    return;
  }

  overlay.style.display = "flex";

  tbody.innerHTML = `
    <tr>
      <td colspan="5" class="loader-disponiveis">
        Carregando alunos...
      </td>
    </tr>
  `;

  try {

    const res = await fetch("/alunos-nao-vinculados");

    if (!res.ok) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="loader-disponiveis" style="color:red">
            Erro ao buscar alunos
          </td>
        </tr>
      `;
      return;
    }

    let alunos = await res.json();

    // filtra nomes vazios
    alunos = alunos.filter(a =>
      a.nome && a.nome.toString().trim() !== ""
    );

    tbody.innerHTML = "";

    if (!alunos.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;font-weight:bold">
            Nenhum aluno dispon√≠vel
          </td>
        </tr>
      `;
      return;
    }

    alunos.forEach(a => {

      tbody.innerHTML += `
        <tr>
          <td>${a.nome}</td>
          <td>${a.disciplina || "‚Äî"}</td>
          <td>${a.bairro || "‚Äî"}</td>
          <td>${a.provincia || "‚Äî"}</td>
          <td class="status-disponivel">
            ${a.online ? "Online" : "Offline"}
          </td>
        </tr>
      `;
    });

  } catch (err) {

    console.error("Erro JS:", err);

    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="loader-disponiveis" style="color:red">
          Erro inesperado
        </td>
      </tr>
    `;
  }
}
  
function fecharAlunosDisponiveis() {

  const overlay = document.getElementById("overlayDisponiveis");
  const tbody = document.querySelector("#tabela-disponiveis tbody");

  // fecha o overlay
  if (overlay) {
    overlay.style.display = "none";
  }

  // limpa tabela
  if (tbody) {
    tbody.innerHTML = "";
  }
}

async function carregarProfessores() {

  const overlay = document.getElementById("overlayProfessores");
  const tbody = document.querySelector("#tabela-professores tbody");
  const select = document.getElementById("lista-professores");

  if (!overlay || !tbody) {
    console.error("Overlay professores n√£o encontrado");
    return;
  }

  overlay.style.display = "flex";

  tbody.innerHTML = `
    <tr>
      <td colspan="4" class="loader-alunos">
        Carregando professores...
      </td>
    </tr>
  `;

  try {

    const res = await fetch("/listar-professores-online");

    if (!res.ok) throw new Error();

    const profs = await res.json();

    tbody.innerHTML = "";

    if (!profs.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" style="text-align:center;font-weight:bold">
            Nenhum professor online
          </td>
        </tr>
      `;
      return;
    }

    if (select) {
      select.innerHTML = `
        <option disabled selected>Selecione o professor</option>
        <option value="todos">Todos os Professores</option>
      `;
    }

    profs.forEach(p => {

      tbody.innerHTML += `
        <tr>

          <td data-label="Email">${p.email}</td>

          <td data-label="Nome">${p.nome}</td>

          <td data-label="Status"
              class="${p.online ? 'prof-online' : 'prof-offline'}">
            ${p.online ? "Online" : "Offline"}
          </td>

          <td data-label="A√ß√µes">
            <button class="btn-prof-remover"
              onclick="removerProfessor('${p.email}')">
              Remover
            </button>
          </td>

        </tr>
      `;

      if (select && p.email) {
        select.innerHTML += `<option value="${p.email}">${p.email}</option>`;
      }

    });

  } catch (err) {

    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="loader-alunos" style="color:red">
          Erro ao carregar professores
        </td>
      </tr>
    `;

  }

}
  
/* =====================================================
   CONTROLE DE SE√á√ïES (MENU FINAN√áAS)
===================================================== */

function mostrarSecao(id) {

    // Esconde todas as se√ß√µes
    document.querySelectorAll(".secao").forEach(sec => {
        sec.style.display = "none";
    });

    // Esconde detalhes
    const detAluno = document.getElementById("detalhes-aluno");
    const detProf = document.getElementById("detalhes-prof");

    if (detAluno) detAluno.style.display = "none";
    if (detProf) detProf.style.display = "none";

    // Mostra se√ß√£o solicitada
    const secao = document.getElementById(id);
    if (secao) secao.style.display = "block";
}



/* =====================================================
   PAGAMENTOS ‚Äî ALUNOS
===================================================== */

async function marcarPago(alunoId, temDivida) {

    if (!temDivida) {
        alert("Este aluno j√° est√° com o pagamento em dia.");
        return;
    }

    const res = await fetch("/listar-pagamentos");
    const alunos = await res.json();

    const aluno = alunos.find(a =>
        a.id === alunoId &&
        a.nome &&
        a.nome.trim() !== ""
    );

    if (!aluno) {
        alert("Aluno n√£o encontrado.");
        return;
    }

    const hoje = new Date();
    const mes = hoje.getMonth() + 1;
    const ano = hoje.getFullYear();

    const valorMensal = aluno.valor_mensal_aluno || 0;

    const resposta = await fetch("/api/registrar-pagamento", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            aluno_nome: aluno.nome,
            mes,
            ano,
            valor_pago: valorMensal,
            pago: true
        })
    });

    if (resposta.ok) {
        alert(`Pagamento de ${aluno.nome} registrado.`);
        carregarPagamentos();
    } else {
        alert("Erro ao registrar pagamento.");
    }
}


async function carregarPagamentos() {

    mostrarSecao("secao-pagamentos");

    try {

        const res = await fetch("/listar-pagamentos");
        if (!res.ok) throw new Error(res.status);

        const alunos = await res.json();
        const tbody = document.querySelector("#tabela-pagamentos tbody");

        tbody.innerHTML = "";

        alunos.forEach(a => {

            if (!a.nome || a.nome.trim() === "") return;

            const temDivida = a.divida && Number(a.divida) > 0;

            const statusCor = temDivida ? "status-vermelho" : "status-verde";
            const statusTexto = temDivida ? "N√ÉO PAGO" : "PAGO";

            let ultimoPagamento = "‚Äî";

            if (a.paga_passado?.length) {
                const ult = a.paga_passado.at(-1);
                ultimoPagamento =
                    `${ult.mes}/${ult.ano} - Kz ${Number(ult.valor_pago || 0).toLocaleString("pt-AO")},00`;
            }

            tbody.innerHTML += `
                <tr>
                  <td>${a.nome}</td>

                  <td>
                    <span class="status-circulo ${statusCor}"></span>
                    ${statusTexto}
                  </td>

                  <td>Kz ${Number(a.divida || 0).toLocaleString("pt-AO")},00</td>

                  <td>${ultimoPagamento}</td>

                  <td>
                    <button onclick="marcarPago('${a.id}', ${temDivida})"
                        class="btn btn-sm btn-success">
                        PAGO
                    </button>

                    <button onclick="verPagamentos('${a.nome}', '${a.nome}')"
                        class="btn btn-sm btn-primary ml-1">
                        Ver Pagamentos
                    </button>
                  </td>
                </tr>
            `;
        });

    } catch (err) {
        console.error(err);
        alert("Erro ao carregar pagamentos.");
    }
}



async function verPagamentos(nomeAluno, nomeExibicao) {

    mostrarSecao("secao-pagamentos");

    try {

        const res = await fetch(`/ver-pagamentos/${encodeURIComponent(nomeAluno)}`);
        if (!res.ok) throw new Error(res.status);

        const data = await res.json();

        document.getElementById("nome-aluno").textContent =
            `üìå Pagamentos de ${nomeExibicao}`;

        const tbody = document.getElementById("tabela-meses");
        tbody.innerHTML = "";

        const historico = data.historico_pagamentos || [];

        if (!historico.length) {
            tbody.innerHTML =
                `<tr><td colspan="4">Nenhum pagamento encontrado</td></tr>`;
        }

        historico.forEach(p => {

            const valor = `Kz ${Number(p.valor_pago || 0).toLocaleString("pt-AO")},00`;
            const pago = p.valor_pago > 0;

            tbody.innerHTML += `
                <tr>
                    <td>${p.mes}</td>
                    <td>${p.ano}</td>
                    <td>${valor}</td>
                    <td class="${pago ? "text-success" : "text-danger"}">
                        ${pago ? "Pago" : "N√£o pago"}
                    </td>
                </tr>
            `;
        });

        document.getElementById("detalhes-aluno").style.display = "block";

    } catch (err) {
        console.error(err);
        alert("Erro ao buscar hist√≥rico.");
    }
}

/* =====================================================
   PAGAMENTOS ‚Äî PROFESSORES
===================================================== */

async function carregarPagamentosProf() {

    mostrarSecao("secao-prof");

    try {

        const res = await fetch("/listar-pagamentos-prof");
        const professores = await res.json();

        const tbody =
            document.querySelector("#tabela-pagamentos-prof tbody");

        tbody.innerHTML = "";

        professores.forEach(p => {

            const emDivida = p.saldo_atual > 0;

            const statusCor = emDivida ? "status-vermelho" : "status-verde";
            const statusTexto = emDivida ? "N√ÉO PAGO" : "PAGO";

            tbody.innerHTML += `
                <tr>
                  <td>
                    <a href="#" onclick="verMesesProf('${p.id}')">
                        ${p.professor}
                    </a>
                  </td>

                  <td>
                    <span class="status-circulo ${statusCor}"></span>
                    ${statusTexto}
                  </td>

                  <td>Kz ${Number(p.saldo_atual).toFixed(2)}</td>

                  <td>
                    <button onclick="marcarPagoProf('${p.id}', ${!emDivida}, '${p.professor}', ${p.saldo_atual})"
                        class="btn btn-sm ${emDivida ? "btn-danger" : "btn-success"}">
                        ${statusTexto}
                    </button>

                    <button onclick="verHistoricoPagamentos('${p.professor}')"
                        class="btn btn-sm btn-primary ml-1">
                        Hist√≥rico
                    </button>
                  </td>
                </tr>
            `;
        });

    } catch (err) {
        console.error(err);
        alert("Erro ao carregar professores.");
    }
}



async function marcarPagoProf(id, statusAtual, professor, saldoAtual) {

    try {

        const url = statusAtual
            ? "/atualizar-pagamento-prof"
            : "/registrar-pagamento-prof";

        await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                id,
                professor,
                valor_pago: statusAtual ? 0 : saldoAtual
            })
        });

        carregarPagamentosProf();

    } catch (err) {
        console.error(err);
        alert("Erro ao atualizar pagamento.");
    }
}



function verHistoricoPagamentos(nomeProfessor) {
    window.location.href =
        `/ver-pagamentos?professor=${encodeURIComponent(nomeProfessor)}`;
}



async function verMesesProf(emailProf) {

    mostrarSecao("secao-prof");

    try {

        const res =
            await fetch(`/salarios?email=${encodeURIComponent(emailProf)}`);

        if (!res.ok) throw new Error(res.status);

        const data = await res.json();

        document.getElementById("nome-prof").textContent = data.nome;
        document.getElementById("saldo-prof").textContent =
            `${Number(data.saldo_atual).toFixed(2)} Kz`;

        const tbody = document.getElementById("tabela-meses");
        tbody.innerHTML = "";

        if (!data.pagamentos?.length) {
            tbody.innerHTML =
                `<tr><td colspan="6">Nenhum pagamento registrado.</td></tr>`;
        }

        data.pagamentos.forEach(p => {

            const pago = p.valor_pago > 0;

            tbody.innerHTML += `
                <tr>
                    <td>${p.mes}</td>
                    <td>${p.data_pagamento || "-"}</td>
                    <td>Kz ${Number(p.valor_pago).toFixed(2)}</td>
                    <td>${p.email_professor || "-"}</td>
                    <td class="${pago ? "text-success" : "text-danger"}">
                        ${pago ? "PAGO" : "N√ÉO PAGO"}
                    </td>
                    <td>
                        <button onclick="marcarPagoMesProf('${emailProf}','${p.mes}',${pago})"
                            class="btn btn-sm ${pago ? "btn-success" : "btn-danger"}">
                            ${pago ? "PAGO" : "N√ÉO PAGO"}
                        </button>
                    </td>
                </tr>
            `;
        });

        document.getElementById("detalhes-prof").style.display = "block";

    } catch (err) {
        console.error(err);
        alert("Erro ao carregar meses.");
    }
}

</script>

</body>
</html>


